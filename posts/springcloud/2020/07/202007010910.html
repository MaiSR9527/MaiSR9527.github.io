<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Spring Cloud Neflix之Eureka入门和实战 | maiBlog</title><meta name="description" content="spring cloud组件列表   组件名称 所属醒目 组件分类    Eureka spring-cloud-neflix 注册中心   Zuul spring-cloud-nexflix 第一代网关   Sidecar spring-cloud-nexflix 多语言   Ribbon spring-cloud-nexflix 负载均衡   Hystrix spring-cloud-nexf"><meta name="keywords" content="springcloud,微服务"><meta name="author" content="maishuren"><meta name="copyright" content="maishuren"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/bitbug-favicon-32x32.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://hm.baidu.com"/><link rel="dns-prefetch" href="https://hm.baidu.com"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Spring Cloud Neflix之Eureka入门和实战"><meta name="twitter:description" content="spring cloud组件列表   组件名称 所属醒目 组件分类    Eureka spring-cloud-neflix 注册中心   Zuul spring-cloud-nexflix 第一代网关   Sidecar spring-cloud-nexflix 多语言   Ribbon spring-cloud-nexflix 负载均衡   Hystrix spring-cloud-nexf"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/MaiSR9527/blog-pic/banner/blogbanner11.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Spring Cloud Neflix之Eureka入门和实战"><meta property="og:url" content="https://www.maishuren.top/posts/springcloud/2020/07/202007010910.html"><meta property="og:site_name" content="maiBlog"><meta property="og:description" content="spring cloud组件列表   组件名称 所属醒目 组件分类    Eureka spring-cloud-neflix 注册中心   Zuul spring-cloud-nexflix 第一代网关   Sidecar spring-cloud-nexflix 多语言   Ribbon spring-cloud-nexflix 负载均衡   Hystrix spring-cloud-nexf"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/MaiSR9527/blog-pic/banner/blogbanner11.jpg"><meta property="article:published_time" content="2020-07-01T01:10:12.000Z"><meta property="article:modified_time" content="2021-04-07T15:42:01.087Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="https://www.maishuren.top/posts/springcloud/2020/07/202007010910.html"><link rel="prev" title="Spring Cloud OpenFeign入门和实战" href="https://www.maishuren.top/posts/springcloud/2020/07/202007030910.html"><link rel="next" title="Docker容器下配置MySQL主从配置" href="https://www.maishuren.top/posts/mysql/2020/06/202006281626.html"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.js" defer></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?0d6717a65ff7b5a1f6c9a03d9d87f2f4";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"HLCQW4XQIU","apiKey":"2b769a4e28e86d9b2629a08dec449623","indexName":"myblog","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  baiduPush: true,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="https://at.alicdn.com/t/font_1900832_ry85jxoks1.css"><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="maiBlog" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><canvas class="fireworks"></canvas><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://cdn.jsdelivr.net/gh/MaiSR9527/blog-pic/blog/newavatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">70</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">21</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">16</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 娱乐</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/playlist/"><i class="fa-fw fa fa-music"></i><span> /歌单</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#spring-cloud组件列表"><span class="toc-number">1.</span> <span class="toc-text">spring cloud组件列表</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Eureka入门案例"><span class="toc-number">2.</span> <span class="toc-text">Eureka入门案例</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Eureka的Rest-API简介"><span class="toc-number">3.</span> <span class="toc-text">Eureka的Rest API简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#REST-API列表"><span class="toc-number">3.1.</span> <span class="toc-text">REST API列表</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Eureka核心类"><span class="toc-number">4.</span> <span class="toc-text">Eureka核心类</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#服务的核心操作"><span class="toc-number">5.</span> <span class="toc-text">服务的核心操作</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Eureka的设计理念"><span class="toc-number">6.</span> <span class="toc-text">Eureka的设计理念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#AP优于CP"><span class="toc-number">6.1.</span> <span class="toc-text">AP优于CP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Peer-to-Peer架构"><span class="toc-number">6.2.</span> <span class="toc-text">Peer to Peer架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Zone及Region设计"><span class="toc-number">6.3.</span> <span class="toc-text">Zone及Region设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SELF-PRESERVATION设计"><span class="toc-number">6.4.</span> <span class="toc-text">SELF PRESERVATION设计</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Eureka参数调优以及监控"><span class="toc-number">7.</span> <span class="toc-text">Eureka参数调优以及监控</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#客户端参数"><span class="toc-number">7.1.</span> <span class="toc-text">客户端参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Client端的核心参数"><span class="toc-number">7.1.1.</span> <span class="toc-text">Client端的核心参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#定时任务参数"><span class="toc-number">7.1.2.</span> <span class="toc-text">定时任务参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#http参数"><span class="toc-number">7.1.3.</span> <span class="toc-text">http参数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#服务端端参数"><span class="toc-number">7.2.</span> <span class="toc-text">服务端端参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基本参数"><span class="toc-number">7.2.1.</span> <span class="toc-text">基本参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#response-cache参数"><span class="toc-number">7.2.2.</span> <span class="toc-text">response cache参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#peer相关参数"><span class="toc-number">7.2.3.</span> <span class="toc-text">peer相关参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#http参数-1"><span class="toc-number">7.2.4.</span> <span class="toc-text">http参数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参数调优"><span class="toc-number">7.3.</span> <span class="toc-text">参数调优</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#常见问题"><span class="toc-number">7.3.1.</span> <span class="toc-text">常见问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#监控指标"><span class="toc-number">7.4.</span> <span class="toc-text">监控指标</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Eureka实战"><span class="toc-number">8.</span> <span class="toc-text">Eureka实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Eureka-Server在线扩容"><span class="toc-number">8.1.</span> <span class="toc-text">Eureka Server在线扩容</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建cloud-config-server子模块。"><span class="toc-number">8.1.1.</span> <span class="toc-text">创建cloud-config-server子模块。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cloud-eureka-server模块"><span class="toc-number">8.1.2.</span> <span class="toc-text">cloud-eureka-server模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cloud-erueka-client子模块"><span class="toc-number">8.1.3.</span> <span class="toc-text">cloud-erueka-client子模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#扩容两个Eureka-Server"><span class="toc-number">8.1.4.</span> <span class="toc-text">扩容两个Eureka Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#扩容小结"><span class="toc-number">8.1.5.</span> <span class="toc-text">扩容小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#构建多zone的Eureka-Server集群"><span class="toc-number">8.2.</span> <span class="toc-text">构建多zone的Eureka Server集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建cloud-eureka-server-multizone模块"><span class="toc-number">8.2.1.</span> <span class="toc-text">创建cloud-eureka-server-multizone模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建cloud-eureka-client-multizone模块"><span class="toc-number">8.2.2.</span> <span class="toc-text">创建cloud-eureka-client-multizone模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建cloud-zuul-gateway"><span class="toc-number">8.2.3.</span> <span class="toc-text">创建cloud-zuul-gateway</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试验证"><span class="toc-number">8.2.4.</span> <span class="toc-text">测试验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#支持Remote-Region"><span class="toc-number">8.3.</span> <span class="toc-text">支持Remote Region</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建cloud-eureka-server-remote-region模块"><span class="toc-number">8.3.1.</span> <span class="toc-text">创建cloud-eureka-server-remote-region模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建cloud-eureka-client-remote-region模块"><span class="toc-number">8.3.2.</span> <span class="toc-text">创建cloud-eureka-client-remote-region模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建cloud-zuul-gateway-remote-region模块"><span class="toc-number">8.3.3.</span> <span class="toc-text">创建cloud-zuul-gateway-remote-region模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试验证-1"><span class="toc-number">8.3.4.</span> <span class="toc-text">测试验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#开启HTTP-Basic认证"><span class="toc-number">8.4.</span> <span class="toc-text">开启HTTP Basic认证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建cloud-eureka-server-http-basic模块"><span class="toc-number">8.4.1.</span> <span class="toc-text">创建cloud-eureka-server-http-basic模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建cloud-eureka-client-http-basic模块"><span class="toc-number">8.4.2.</span> <span class="toc-text">创建cloud-eureka-client-http-basic模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#启用https"><span class="toc-number">8.5.</span> <span class="toc-text">启用https</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#证书准备"><span class="toc-number">8.5.1.</span> <span class="toc-text">证书准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建cloud-eureka-server-https模块"><span class="toc-number">8.5.2.</span> <span class="toc-text">创建cloud-eureka-server-https模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建cloud-eureka-client-https模块"><span class="toc-number">8.5.3.</span> <span class="toc-text">创建cloud-eureka-client-https模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Eureka-Admin"><span class="toc-number">8.6.</span> <span class="toc-text">Eureka Admin</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Eureka故障演练"><span class="toc-number">9.</span> <span class="toc-text">Eureka故障演练</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Eureka-Server全部不可用"><span class="toc-number">9.1.</span> <span class="toc-text">Eureka Server全部不可用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#启动前全部不可用"><span class="toc-number">9.1.1.</span> <span class="toc-text">启动前全部不可用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#运行时全部不可用"><span class="toc-number">9.1.2.</span> <span class="toc-text">运行时全部不可用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Eureka-Server部分不可用"><span class="toc-number">9.2.</span> <span class="toc-text">Eureka Server部分不可用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Server端"><span class="toc-number">9.2.1.</span> <span class="toc-text">Server端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Client端"><span class="toc-number">9.2.2.</span> <span class="toc-text">Client端</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结"><span class="toc-number">10.</span> <span class="toc-text">总结</span></a></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://cdn.jsdelivr.net/gh/MaiSR9527/blog-pic/banner/blogbanner11.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">maiBlog</a></span><span class="pull_right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 娱乐</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/playlist/"><i class="fa-fw fa fa-music"></i><span> /歌单</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Spring Cloud Neflix之Eureka入门和实战</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-07-01 09:10:12"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-07-01</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2021-04-07 23:42:01"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2021-04-07</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a><i class="fa fa-angle-right post-meta__separator" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%90%8E%E7%AB%AF/java/">java</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon fa fa-file-word-o" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">14.2k</span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-clock-o" aria-hidden="true"></i><span>阅读时长: 63 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/posts/springcloud/2020/07/202007010910.html#post-comment" itemprop="discussionUrl"><span class="valine-comment-count comment-count" data-xid="/posts/springcloud/2020/07/202007010910.html" itemprop="commentCount"></span></a></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="spring-cloud组件列表"><a href="#spring-cloud组件列表" class="headerlink" title="spring cloud组件列表"></a>spring cloud组件列表</h1><table>
<thead>
<tr>
<th>组件名称</th>
<th>所属醒目</th>
<th>组件分类</th>
</tr>
</thead>
<tbody><tr>
<td>Eureka</td>
<td>spring-cloud-neflix</td>
<td>注册中心</td>
</tr>
<tr>
<td>Zuul</td>
<td>spring-cloud-nexflix</td>
<td>第一代网关</td>
</tr>
<tr>
<td>Sidecar</td>
<td>spring-cloud-nexflix</td>
<td>多语言</td>
</tr>
<tr>
<td>Ribbon</td>
<td>spring-cloud-nexflix</td>
<td>负载均衡</td>
</tr>
<tr>
<td>Hystrix</td>
<td>spring-cloud-nexflix</td>
<td>熔断器</td>
</tr>
<tr>
<td>Turbine</td>
<td>spring-cloud-nexflix</td>
<td>集群监控</td>
</tr>
<tr>
<td>Feign</td>
<td>spring-cloud-openfeign</td>
<td>声明式HTTP客户端</td>
</tr>
<tr>
<td>Consul</td>
<td>spring-cloud-consul</td>
<td>注册中心</td>
</tr>
<tr>
<td>Gateway</td>
<td>spring-cloud-gateway</td>
<td>第二代网关</td>
</tr>
<tr>
<td>Sleuth</td>
<td>spring-cloud-sleuth</td>
<td>链路追踪</td>
</tr>
<tr>
<td>Config</td>
<td>spring-cloud-config</td>
<td>配置中心</td>
</tr>
<tr>
<td>Bus</td>
<td>spring-cloud-bus</td>
<td>总线</td>
</tr>
<tr>
<td>Pipeline</td>
<td>spring-cloud-pipelines</td>
<td>部署管道</td>
</tr>
<tr>
<td>Dataflow</td>
<td>spring-cloud-dataflow</td>
<td>数据处理</td>
</tr>
<tr>
<td>Nacos</td>
<td>spring-cloud-alibaba</td>
<td>注册中心、配置中心</td>
</tr>
<tr>
<td>Sentinel</td>
<td>spring-cloud-alibaba</td>
<td>流量控制和服务降级</td>
</tr>
<tr>
<td>Seata</td>
<td>spring-cloud-alibaba</td>
<td>分布式事务</td>
</tr>
<tr>
<td>Dubbo RPC</td>
<td>spring-cloud-alibaba</td>
<td>RPC</td>
</tr>
</tbody></table>
<p>spring cloud和spring boot的版本对应</p>
<table>
<thead>
<tr>
<th align="center">Spring Cloud版本</th>
<th align="center">Spring Boot版本</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Hoxton</td>
<td align="center">2.2.x, 2.3.x (Starting with SR5)</td>
</tr>
<tr>
<td align="center">Greenwich</td>
<td align="center">2.1.x</td>
</tr>
<tr>
<td align="center">Finchley</td>
<td align="center">2.0.x</td>
</tr>
<tr>
<td align="center">Edgware</td>
<td align="center">1.5.x</td>
</tr>
<tr>
<td align="center">Dalston</td>
<td align="center">1.5.x</td>
</tr>
</tbody></table>
<h1 id="Eureka入门案例"><a href="#Eureka入门案例" class="headerlink" title="Eureka入门案例"></a>Eureka入门案例</h1><ol>
<li>创建Maven父级pom工程</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">spring.cloud-version</span>&gt;</span>Hoxton.SR3<span class="tag">&lt;/<span class="name">spring.cloud-version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.cloud-version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2.在父级工程下创建Eureka Server子模块</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">   </span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.msr.better.registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaServerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaServerApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置文件</p>
<p>application.yml(<strong>单机版</strong>)</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8761</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">registerWithEureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">fetchRegistry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">waitTimeInMsWhenSyncEmpty:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">enableSelfPreservation:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>3.在父级工程下创建Eureka Client子模块</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">   </span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>   启动类</p>
   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.msr.better.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ServiceApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>   配置文件：<code>resources/application.yml</code></p>
   <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-eureka-client1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/</span> <span class="comment"># 一个Eureka Server</span></span><br></pre></td></tr></table></figure>

<p>4.演示效果</p>
<p>启动Eureka Server和Eureka Client。在浏览器访问<a href="http://localhost:8761。可以看到有一个Eureka">http://localhost:8761。可以看到有一个Eureka</a> Client成功注册到Eureka Server中来了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/MaiSR9527/blog-pic/springcloud/eureka1.jpg" alt=""></p>
<p>访问Eureka Server的REST API接口：<a href="http://localhost:8761/eureka/apps，返回结果如下。" target="_blank" rel="noopener">http://localhost:8761/eureka/apps，返回结果如下。</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">applications</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">versions__delta</span>&gt;</span>1<span class="tag">&lt;/<span class="name">versions__delta</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">apps__hashcode</span>&gt;</span>UP_1_<span class="tag">&lt;/<span class="name">apps__hashcode</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">application</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>CLOUD-EUREKA-CLIENT1<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">instance</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;<span class="name">instanceId</span>&gt;</span>DESTOP-IUCSN852:cloud-eureka-client1:8081<span class="tag">&lt;/<span class="name">instanceId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">hostName</span>&gt;</span>DESTOP-IUCSN852<span class="tag">&lt;/<span class="name">hostName</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">app</span>&gt;</span>CLOUD-EUREKA-CLIENT1<span class="tag">&lt;/<span class="name">app</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">ipAddr</span>&gt;</span>192.168.3.2<span class="tag">&lt;/<span class="name">ipAddr</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">status</span>&gt;</span>UP<span class="tag">&lt;/<span class="name">status</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">overriddenstatus</span>&gt;</span>UNKNOWN<span class="tag">&lt;/<span class="name">overriddenstatus</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">port</span> <span class="attr">enabled</span>=<span class="string">"true"</span>&gt;</span>8081<span class="tag">&lt;/<span class="name">port</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">securePort</span> <span class="attr">enabled</span>=<span class="string">"false"</span>&gt;</span>443<span class="tag">&lt;/<span class="name">securePort</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">countryId</span>&gt;</span>1<span class="tag">&lt;/<span class="name">countryId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">dataCenterInfo</span> <span class="attr">class</span>=<span class="string">"com.netflix.appinfo.InstanceInfo$DefaultDataCenterInfo"</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>MyOwn<span class="tag">&lt;/<span class="name">name</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;/<span class="name">dataCenterInfo</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">leaseInfo</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">renewalIntervalInSecs</span>&gt;</span>30<span class="tag">&lt;/<span class="name">renewalIntervalInSecs</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">durationInSecs</span>&gt;</span>90<span class="tag">&lt;/<span class="name">durationInSecs</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">registrationTimestamp</span>&gt;</span>1612541898071<span class="tag">&lt;/<span class="name">registrationTimestamp</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">lastRenewalTimestamp</span>&gt;</span>1612541898071<span class="tag">&lt;/<span class="name">lastRenewalTimestamp</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">evictionTimestamp</span>&gt;</span>0<span class="tag">&lt;/<span class="name">evictionTimestamp</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">serviceUpTimestamp</span>&gt;</span>1612541898071<span class="tag">&lt;/<span class="name">serviceUpTimestamp</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;/<span class="name">leaseInfo</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">metadata</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">management.port</span>&gt;</span>8081<span class="tag">&lt;/<span class="name">management.port</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;/<span class="name">metadata</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">homePageUrl</span>&gt;</span>http://DESTOP-IUCSN852:8081/<span class="tag">&lt;/<span class="name">homePageUrl</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">statusPageUrl</span>&gt;</span>http://DESTOP-IUCSN852:8081/actuator/info<span class="tag">&lt;/<span class="name">statusPageUrl</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">healthCheckUrl</span>&gt;</span>http://DESTOP-IUCSN852:8081/actuator/health<span class="tag">&lt;/<span class="name">healthCheckUrl</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">vipAddress</span>&gt;</span>cloud-eureka-client1<span class="tag">&lt;/<span class="name">vipAddress</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">secureVipAddress</span>&gt;</span>cloud-eureka-client1<span class="tag">&lt;/<span class="name">secureVipAddress</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">isCoordinatingDiscoveryServer</span>&gt;</span>false<span class="tag">&lt;/<span class="name">isCoordinatingDiscoveryServer</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">lastUpdatedTimestamp</span>&gt;</span>1612541898071<span class="tag">&lt;/<span class="name">lastUpdatedTimestamp</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">lastDirtyTimestamp</span>&gt;</span>1612541897993<span class="tag">&lt;/<span class="name">lastDirtyTimestamp</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">actionType</span>&gt;</span>ADDED<span class="tag">&lt;/<span class="name">actionType</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">instance</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;/<span class="name">application</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">applications</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="Eureka的Rest-API简介"><a href="#Eureka的Rest-API简介" class="headerlink" title="Eureka的Rest API简介"></a>Eureka的Rest API简介</h1><p>​        Eureka是Netflix公司开源的一款服务发现组件，该组件提供的服务发现可以为负载均衡、failover等提供支持。Eureka包括Eureka Server和Eureka Client。Eureka Server提供REST服务，Eureka Client则是Java编写的客户端。</p>
<h2 id="REST-API列表"><a href="#REST-API列表" class="headerlink" title="REST API列表"></a>REST API列表</h2><table>
<thead>
<tr>
<th align="center">操作</th>
<th align="center">http动作</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">注册新的实例</td>
<td align="center">POST /eureka/apps/{appId}</td>
<td align="center">可以输入json或xml格式的body</td>
</tr>
<tr>
<td align="center">注销应用实例</td>
<td align="center">DELETE /eureka/apps/{appId}/{instanceId}</td>
<td align="center">成功返回200</td>
</tr>
<tr>
<td align="center">向应用实例发送心跳</td>
<td align="center">PUT /eureka/apps/{appId}/{instanceId}</td>
<td align="center">成功返回200，如果instanceId不存在返回404</td>
</tr>
<tr>
<td align="center">查询所有实例</td>
<td align="center">GET /eureka/apps</td>
<td align="center">成功返回200，输出json或xml格式</td>
</tr>
<tr>
<td align="center">查询指定appId的实例</td>
<td align="center">GET /eureka/apps/{appId}</td>
<td align="center">成功返回200，输出json或xml格式</td>
</tr>
<tr>
<td align="center">根据指定appId和instanceId查询</td>
<td align="center">GET /eureka/apps/{appId}/{instanceId}</td>
<td align="center">成功返回200，输出json或xml格式</td>
</tr>
<tr>
<td align="center">根据指定instanceId查询</td>
<td align="center">GET /eureka/instances/{instanceId}</td>
<td align="center">成功返回200，输出json或xml格式</td>
</tr>
<tr>
<td align="center">暂停应用实例</td>
<td align="center">PUT /eureka/apps/{appId}/{instanceId}/status?value=OUT_OF_SERVICE</td>
<td align="center">成功返回200，失败返回500</td>
</tr>
<tr>
<td align="center">恢复应用实例</td>
<td align="center">DELETE /eureka/apps/{appId}/{instanceId}/status?value=UP(value参数可以不传)</td>
<td align="center">成功返回200，失败返回500</td>
</tr>
<tr>
<td align="center">更新元数据</td>
<td align="center">PUT /eureka/apps/{appId}/{instanceId}/metadata?key=value</td>
<td align="center">成功返回200，失败返回500</td>
</tr>
<tr>
<td align="center">根据vip地址查询</td>
<td align="center">GET /eureka/vips/{vipAddress}</td>
<td align="center">成功返回200，输出json或xml格式</td>
</tr>
<tr>
<td align="center">根据svip地址查询</td>
<td align="center">GET /eureka/svips/{svipAddress}</td>
<td align="center">成功返回200，输出json或xml格式</td>
</tr>
</tbody></table>
<h1 id="Eureka核心类"><a href="#Eureka核心类" class="headerlink" title="Eureka核心类"></a>Eureka核心类</h1><p>InstanceInfo(com.netflix.appinfo.InstanceInfo)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InstanceInfo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String VERSION_UNKNOWN = <span class="string">"unknown"</span>;</span><br><span class="line">    <span class="comment">// 日志</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(InstanceInfo<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="comment">// 默认端口</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_PORT = <span class="number">7001</span>;</span><br><span class="line">    <span class="comment">// https默认端口</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_SECURE_PORT = <span class="number">7002</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_COUNTRY_ID = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 实例id</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String instanceId;</span><br><span class="line">    <span class="comment">// 应用名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String appName;</span><br><span class="line">    <span class="comment">// 应用所属群组</span></span><br><span class="line">    <span class="meta">@Auto</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String appGroupName;</span><br><span class="line">    <span class="comment">// IP地址</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String ipAddr;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SID_DEFAULT = <span class="string">"na"</span>;</span><br><span class="line">    <span class="comment">// 被废弃的属性，默认为na</span></span><br><span class="line">    <span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String sid;</span><br><span class="line">    <span class="comment">// 端口号</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> port;</span><br><span class="line">    <span class="comment">// https端口号</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> securePort;</span><br><span class="line">    <span class="comment">// 应用实例的首页url</span></span><br><span class="line">    <span class="meta">@Auto</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String homePageUrl;</span><br><span class="line">    <span class="comment">// 应用实例的状态页的url</span></span><br><span class="line">    <span class="meta">@Auto</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String statusPageUrl;</span><br><span class="line">    <span class="comment">// 应用实例健康检查的url</span></span><br><span class="line">    <span class="meta">@Auto</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String healthCheckUrl;</span><br><span class="line">    <span class="comment">// 应用实例健康检查https的url</span></span><br><span class="line">    <span class="meta">@Auto</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String secureHealthCheckUrl;</span><br><span class="line">    <span class="comment">// 虚拟ip地址</span></span><br><span class="line">    <span class="meta">@Auto</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String vipAddress;</span><br><span class="line">    <span class="comment">// https的虚拟ip地址</span></span><br><span class="line">    <span class="meta">@Auto</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String secureVipAddress;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="meta">@XStreamOmitField</span></span><br><span class="line">    <span class="keyword">private</span> String statusPageRelativeUrl;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="meta">@XStreamOmitField</span></span><br><span class="line">    <span class="keyword">private</span> String statusPageExplicitUrl;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="meta">@XStreamOmitField</span></span><br><span class="line">    <span class="keyword">private</span> String healthCheckRelativeUrl;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="meta">@XStreamOmitField</span></span><br><span class="line">    <span class="keyword">private</span> String healthCheckSecureExplicitUrl;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="meta">@XStreamOmitField</span></span><br><span class="line">    <span class="keyword">private</span> String vipAddressUnresolved;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="meta">@XStreamOmitField</span></span><br><span class="line">    <span class="keyword">private</span> String secureVipAddressUnresolved;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="meta">@XStreamOmitField</span></span><br><span class="line">    <span class="keyword">private</span> String healthCheckExplicitUrl;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> countryId;</span><br><span class="line">    <span class="comment">// 是否开启https端口</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> isSecurePortEnabled;</span><br><span class="line">    <span class="comment">// 是否开启http端口</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> isUnsecurePortEnabled;</span><br><span class="line">    <span class="comment">// dataCenter信息，如Neflix或者Amazon或者MyOwn</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> DataCenterInfo dataCenterInfo;</span><br><span class="line">    <span class="comment">// 主机名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String hostName;</span><br><span class="line">    <span class="comment">// 实例状态，如：UP，DOWN、STARTING、OUT_OFSERVICE、UNKNOWN</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> InstanceInfo.InstanceStatus status;</span><br><span class="line">    <span class="comment">// 外界需要强制覆盖的状态值，默认为UNKNOWN</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> InstanceInfo.InstanceStatus overriddenStatus;</span><br><span class="line">    <span class="meta">@XStreamOmitField</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> isInstanceInfoDirty;</span><br><span class="line">    <span class="comment">// 租约信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> LeaseInfo leaseInfo;</span><br><span class="line">    <span class="comment">// 首先标识是否discoveryServer，其实标识改discoveryServer是否是响应你请求的实例</span></span><br><span class="line">    <span class="meta">@Auto</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Boolean isCoordinatingDiscoveryServer;</span><br><span class="line">    <span class="comment">// 应用实例的元数据信息</span></span><br><span class="line">    <span class="meta">@XStreamAlias</span>(<span class="string">"metadata"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Map&lt;String, String&gt; metadata;</span><br><span class="line">    <span class="comment">// 状态信息最后更新时间</span></span><br><span class="line">    <span class="meta">@Auto</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Long lastUpdatedTimestamp;</span><br><span class="line">    <span class="comment">// 实例信息最新的过期时间，在Client端用于表示给实例信息是否与Eureka Server一致，在Server端用于多个Eureka Server的信息同步处理</span></span><br><span class="line">    <span class="meta">@Auto</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Long lastDirtyTimestamp;</span><br><span class="line">    <span class="comment">// 表示Eureka Server对改实例执行的操作，包括ADDED、MODIFIED、DELETED这三类</span></span><br><span class="line">    <span class="meta">@Auto</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> InstanceInfo.ActionType actionType;</span><br><span class="line">    <span class="comment">// 在AWS的autoscaling group的名称</span></span><br><span class="line">    <span class="meta">@Auto</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String asgName;</span><br><span class="line">    <span class="comment">// 版本</span></span><br><span class="line">    <span class="keyword">private</span> String version;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 无参构造函数</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">InstanceInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sid = <span class="string">"na"</span>;</span><br><span class="line">        <span class="keyword">this</span>.port = <span class="number">7001</span>;</span><br><span class="line">        <span class="keyword">this</span>.securePort = <span class="number">7002</span>;</span><br><span class="line">        <span class="keyword">this</span>.countryId = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">this</span>.isSecurePortEnabled = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.isUnsecurePortEnabled = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = InstanceInfo.InstanceStatus.UP;</span><br><span class="line">        <span class="keyword">this</span>.overriddenStatus = InstanceInfo.InstanceStatus.UNKNOWN;</span><br><span class="line">        <span class="keyword">this</span>.isInstanceInfoDirty = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.isCoordinatingDiscoveryServer = Boolean.FALSE;</span><br><span class="line">        <span class="keyword">this</span>.version = <span class="string">"unknown"</span>;</span><br><span class="line">        <span class="keyword">this</span>.metadata = <span class="keyword">new</span> ConcurrentHashMap();</span><br><span class="line">        <span class="keyword">this</span>.lastUpdatedTimestamp = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">this</span>.lastDirtyTimestamp = <span class="keyword">this</span>.lastUpdatedTimestamp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 其他省略...</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>租约信息类：LeaseInfo(com.netflix.appinfo.LeaseInfo)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LeaseInfo</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 默认的续约周期时间，单位秒</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_LEASE_RENEWAL_INTERVAL = <span class="number">30</span>;</span><br><span class="line">    <span class="comment">// 默认的租约有效时长，单位秒</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_LEASE_DURATION = <span class="number">90</span>;</span><br><span class="line">    <span class="comment">// Client端续约的间隔周期</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> renewalIntervalInSecs;</span><br><span class="line">    <span class="comment">// Client端需要设置的租约的有效时长</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> durationInSecs;</span><br><span class="line">    <span class="comment">// Server端设置该租约的第一次注册时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> registrationTimestamp;</span><br><span class="line">    <span class="comment">// Server端设置的该租约的最后一次续约时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> lastRenewalTimestamp;</span><br><span class="line">    <span class="comment">// Server端设置的该租约被剔除的时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> evictionTimestamp;</span><br><span class="line">    <span class="comment">// Server端设置的该服务实例标记为UP的时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> serviceUpTimestamp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 无参构造函数</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LeaseInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.renewalIntervalInSecs = <span class="number">30</span>;</span><br><span class="line">        <span class="keyword">this</span>.durationInSecs = <span class="number">90</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        service discovery的实例信息的抽象接口，约定了服务发现的实例应用有哪些通用的信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ServiceInstance</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">default</span> String <span class="title">getInstanceId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 实例的id</span></span><br><span class="line">    <span class="function">String <span class="title">getServiceId</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="comment">// 实例的host</span></span><br><span class="line">    <span class="function">String <span class="title">getHost</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="comment">// 实例端口</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getPort</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="comment">// 实例是否开启了https</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isSecure</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="comment">// 实例uri地址</span></span><br><span class="line">    <span class="function">URI <span class="title">getUri</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="comment">// 元数据信息</span></span><br><span class="line">    <span class="function">Map&lt;String, String&gt; <span class="title">getMetadata</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="comment">// 实例的scheme</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> String <span class="title">getScheme</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        由于Spring Cloud Discovery适配了Zookeeper、Consul、Netflix Eureka、Nacos等注册中心，因此其ServiceInstance定义更为抽象和通用，而且采取的是定义方法的方式。Spring Cloud对该接口的实现类为EurekaRegistration(org.springframework.cloud.netflix.eureka.serviceregistry.EurekaRegistration)，EurekaRegistration实现了ServiceInstance接口。</p>
<p>InstanceStatus是InstanceInfo内的枚举类，用于标识服务实例的状态。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> InstanceStatus &#123;</span><br><span class="line">        UP,</span><br><span class="line">        DOWN,</span><br><span class="line">        STARTING,</span><br><span class="line">        OUT_OF_SERVICE,</span><br><span class="line">        UNKNOWN;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">InstanceStatus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> InstanceInfo.<span class="function">InstanceStatus <span class="title">toEnum</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> valueOf(s.toUpperCase());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IllegalArgumentException var2) &#123;</span><br><span class="line">                    InstanceInfo.logger.debug(<span class="string">"illegal argument supplied to InstanceStatus.valueOf: &#123;&#125;, defaulting to &#123;&#125;"</span>, s, UNKNOWN);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> UNKNOWN;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>​        从定义可以看得出来，服务实例主要有UP、DOWN、STARTING、OUT_OFSERVICE、UNKNOWN这几个状态。其中OUT_OF_SERVICE标识停止服务，即停止接收请求，处于这个状态的服务实例将不会被路由到，经常用于升级部署的场景。</p>
<h1 id="服务的核心操作"><a href="#服务的核心操作" class="headerlink" title="服务的核心操作"></a>服务的核心操作</h1><p>对于服务发现来说，围绕服务实例主要有一下几个重要的操作：</p>
<ul>
<li>服务注册(register)</li>
<li>服务下线(cancel)</li>
<li>服务租约(renew)</li>
<li>服务剔除(evict)</li>
</ul>
<p>围绕这几个功能，Eureka设计了几个核心操作类：</p>
<ul>
<li>com.netflix.eureka.lease.LeaseManager</li>
<li>com.netflix.discovery.shared.LookupService</li>
<li>com.netflix.eureka.registry.InstanceRegistry</li>
<li>com.netflix.eureka.registry.AbstractInstanceRegistry</li>
<li>com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl</li>
</ul>
<p>Spring CloudEureka在netflix Eureka的基础上，抽象或定义了如下核心类：</p>
<ul>
<li>org.springframework.cloud.netflix.eureka.server.InstanceRegistry</li>
<li>org.springframework.cloud.client.serviceregistry.ServiceRegistry</li>
<li>org.springframework.cloud.netflix.eureka.serviceregistry.EurekaServiceRegistry</li>
<li>org.springframework.cloud.netflix.eureka.serviceregistry.EurekaRegistration</li>
<li>org.springframework.cloud.netflix.eureka.EurekaClientAutoConfiguration</li>
<li>org.springframework.cloud.netflix.eureka.EurekaClientConfigBean</li>
<li>org.springframework.cloud.netflix.eureka.EurekaInstanceConfigBean</li>
</ul>
<p>其中LeaseManager以及LookupService是Eureka关于服务发现相关的操作定义的接口。前者定义了服务写操作相关的方法，后者定义了查询操作相关的方法。</p>
<p>LeaseManager(com.netflix.eureka.lease.LeaseManager)</p>
<p>​        该接口定义了应用服务实例在服务中心的几个操作方法：register、cansel、renew、evict。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LeaseManager</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// 用于注册服务实例信息</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(T var1, <span class="keyword">int</span> var2, <span class="keyword">boolean</span> var3)</span></span>;</span><br><span class="line">	<span class="comment">// 用于删除服务实例信息</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(String var1, String var2, <span class="keyword">boolean</span> var3)</span></span>;</span><br><span class="line">	<span class="comment">// 用于与Eureka Server进行心跳操作，维持租约</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">renew</span><span class="params">(String var1, String var2, <span class="keyword">boolean</span> var3)</span></span>;</span><br><span class="line">	<span class="comment">// 服务端的一个方法，用于剔除租约过期的服务实例信息</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">evict</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LookupService(com.netflix.discovery.shared.LookupService)</p>
<p>该接口定义了Eureka Client从服务中心获取服务实例的查询方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LookupService</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">Application <span class="title">getApplication</span><span class="params">(String var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Applications <span class="title">getApplications</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;InstanceInfo&gt; <span class="title">getInstancesById</span><span class="params">(String var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">InstanceInfo <span class="title">getNextServerFromEureka</span><span class="params">(String var1, <span class="keyword">boolean</span> var2)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个接口主要是给Client端使用的，其中定义了获取所有应用信息、根据应用id获取所有服务实例，以及根据visualHostname使用round-robin方式获取下一个服务实例。</p>
<h1 id="Eureka的设计理念"><a href="#Eureka的设计理念" class="headerlink" title="Eureka的设计理念"></a>Eureka的设计理念</h1><p>作为一个服务注册于发现中心，主要解决如下几个问题：</p>
<ol>
<li><strong>服务实例如何注册到服务中心</strong></li>
</ol>
<p>​        本质上就是在服务启动的时候，需要调用Eureka Server的REST API的register方法，去注册应用实例的信息。对于Java应用则是使用Eureka Client封装好的API去调用；对于Spring Cloud应用更加简单，可以使用spring-cloud-starter-netflix-eureka-client，基于Spring Boot的自动配置，自动帮你实现服务信息的注册。</p>
<ol start="2">
<li><strong>服务实例如何从服务中心剔除</strong></li>
</ol>
<p>​        正常情况下服务实例在关闭应用的时候，应该通过狗子方法或其他生命周期回调方法去调用Eureka Server的REST API的de-register方法，来删除自身服务实例。另外对于服务实例挂掉或者其他异常情况没有及时删除自身信息的问题，Eureka Server要求Client端定时进行续约，也就是发送心跳，来证明服务实例是健康的，是可以调用的。如果租约超过一定时间没有进行续约操作，Eureka Server端会主动剔除。这一点Eureka Server采用的就是分布式应用里面经典的心跳模式。</p>
<ol start="3">
<li><strong>服务实例信息的一致性问题</strong></li>
</ol>
<p>​        由于服务注册以及发现中心可能是单点的，其自身必有个集群。下面主要分为AP优于CP、Peer to Peer架构、Zone以及Region设计，SELF PRESERVATION设计四个方面。</p>
<h2 id="AP优于CP"><a href="#AP优于CP" class="headerlink" title="AP优于CP"></a>AP优于CP</h2><p>分布式系统的CAP三个特性：</p>
<p>C(Consistency)：数据一致性，即数据在存在多个副本的情况下，可能由于网络、机器故障、软件系统等问题导致数据写入部分副本成功，部分副本失败，进而造成副本之间数据出现不一致的，存在冲突。满足一致性则要求对数据进行更新操作之后，多副本的数据保持一致。</p>
<p>A(Availability)：可靠性，在任何时候客户端对集群进行读写操作，求情都能正常响应，即在一定的延时延时内完成。</p>
<p>P(Partition Tolerance)：分区容错性，即发生通讯故障的时候，整个集群被分割为多个无法互相通信的分区是，集群仍然可用。</p>
<p>​        对于分布式系统来说，一般网络条件相对不可控，出现网络分区是不可避免的，因此系统必须具备分区容错性。在这个前提下，分布式系统的设计则在CP和AP之间进行选择。不能理解成CAP三者之间必须三选二，他们三者之间不是对等和可以互相替换的。在分布式领域中，P是一个客观存在的事实，不可绕过，所以P与AC之间不是对等关系。</p>
<p>​        对于ZooKeeper，它就是CP的，但又不是严格的强一致性，比如客户端A提交了一个写操作，ZooKeeper在板书节点操作成功之后返回，此时假设客户端B的读操作请求到的是A写操作尚未同步到的节点，那么读取到的就不是客户端A歇菜做成功之后的数据。如果在使用的时候需要强一致性，则需要在读取数据的使用执行以下sync操作，即leader节点先同步下数据，这样才能保证强一致。在极端的情况下发生网络分区的时候，如果leader节点不在non-quorum分区，那么对这个分区上节点的读写操作请求将会报错，无法满足Availability特性。</p>
<p>​        Eureka是在部署AWS的背景下设计的，其设计者认为，在云端特别是在大规模部署的情况下，失败是不可避免的，有可能是Eureka自身部署失败，注册的服务不可用，或者由于出现网络分区导致服务不可用，因此不能回避这个问题。所以要在出现了这些问题了，还要能继续提供服务注册以及发现功能，Eureka才选择满足Availability(可靠性)。所以Eureka会保留可用及过期的数据，总比丢掉可用的数据好。这样的话，应用实例的注册信息在集群中的所有节点并不是强一致的，这就需要客户端能够支持负载均衡以及失败重试。在Netflix的生态里面，有ribbon提供这一个功能。</p>
<h2 id="Peer-to-Peer架构"><a href="#Peer-to-Peer架构" class="headerlink" title="Peer to Peer架构"></a>Peer to Peer架构</h2><p>在分布式系统中数据存在过个副本之间的复制，复制方式可分为主从复制和对等复制。</p>
<ol>
<li><p><strong>主从复制</strong></p>
<p>主从复制也就是广为人知的Master-Slave模式，即有一个主副本，其他副本是从副本。所有数据的写操作都提交到主副本中，最后由主副本更新到其他从副本。有同步更新、异步更新、同步及异步混合。</p>
</li>
<li><p><strong>对等复制</strong></p>
<p>​        即Peer to Peer模式，由于任何副本都可以接收写操作，不存在写操作的压力瓶颈。但是由于每个副本都可以进行写操作处理，个副本之间的数据同步以及冲突处理是一个比较棘手的问题。</p>
<p>​        Eureka采用的就是Peer to Peer的复制模式。下面分为Client端和Server端两个角度。</p>
<p>（1）Client端</p>
<p>Client端一般通过下面的配置Eureka Server的peer节点：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/,http://localhost:8762/eureka/</span></span><br></pre></td></tr></table></figure>

<p>​        实际上代码里支持preferSameZoneEureka，即有多个分区的话，优先选择与应用实例所在分区一样的其他服务实例，如果没有找到默认使用defaultZone。客户端使用quarantineSet维护一个不可用的Eureka Server列表，进行请求的时候，优先从可用的列表中进行选择，如果请求失败，则切换到下一Eureka Server实例进行充实，重试次数默认是3。</p>
<p>​        另外为了防止每个Client都按照上面配置的Server列表指定的顺序来访问，而造成Erueka Server节点请求分布不均的情况，Client端有一个定时任务(默认5分钟执行一次)来刷洗并随机化Eureka Server的列表。</p>
<p>（2）Server端</p>
<p>​        Eureka Server本身就依赖了Eureka Client，因为每个Eureka Server是作为其他Eureka Server的Client。在单个Eureka Server启动的时候，会有一个syncUp的操作，通过Eureka Client请求其他Eureka Server节点中的一个节点获取注册的应用实例信息，然后复制到其他peer节点。</p>
<p>​        Eureka Server在执行复制操作的时候，使用HEADER_REPLICATION的http header来讲这个请求操作与普通的应用实例的正常操作区分开来。通过HEADER_REPLICATION来标识是复制请求，这样其他peer节点接收到请求的时候，就不会对它的peer节点进行复制操作，从而避免死循环。</p>
<p>​        Eureka Server使用peer ot peer的复制模式，重点解决的是另外一个问题：数据复制冲突。解决方法：</p>
<ul>
<li>lastDirtyTimestamp标识</li>
<li>heartbeat</li>
</ul>
<p>​        针对数据的不一致，一般是通过版本号机制来解决的，最后在不同的副本之间判断请求复制数据的版本号与本地数据的版本号的高低就行了。Eureka没有直接使用版本号的属性，而是使用lastDirtyTimestamp的字段来对比。</p>
<p>如果开启了SyncWhenTimestampDiffers配置(默认开启)，当lastDirtyTimestamp不为空的时候，就会做相应的处理：</p>
<ul>
<li>如果请求参数的lastDirtyTimestamp值大于Server本地该实例的lastDirtyTimstamp值，则表示EurekaServer之间的数据出现冲突，这个时候就返回404，要求应用实例重新进行register操作。</li>
<li>如果请求参数的lastDirtyTimestamp值小于Server本地该实例的lstDirtyTimestamp值，如果是peer节点的复制请求，则表示数据出现冲突，返回409给peer节点，要求其同步自己最新的数据信息。</li>
</ul>
<p>​        peer节点之间的相互复制不能保证所有操作都成功，所以Eureka还要通过应用实例与Server之间的heartbeat也就是renewLease操作来进行数据的最终修复，如果发现应用实例数据与某个Server的数据出现不一致，则Server返回404，应用实例重新进行register操作。</p>
</li>
</ol>
<h2 id="Zone及Region设计"><a href="#Zone及Region设计" class="headerlink" title="Zone及Region设计"></a>Zone及Region设计</h2><p>​        Netflix的服务大部分在Amazon上，因此Eureka的设计有一部分也是基于Amazon的Zone及Region的基础设施之上。在AmazonEC2托管在全球的各个地方，它用Region来代表一个独立的地理区域，比如Eureka  Server默认设置了个Region : us-east-I、us - west-I、us-west-2、eu-west-1。</p>
<p>​        在每个Region下面，还分了多个AvailabilityZone，一个Region对应多个AvailabilityZone。每一个Region之间是相互独立以及隔离的，默认情况下资源只在单个Region之间的AvailabilityZone进行复制，跨Regin之间不会进行资源复制。Region和AvailabilityZone之间的关系如下：</p>
<h2 id="SELF-PRESERVATION设计"><a href="#SELF-PRESERVATION设计" class="headerlink" title="SELF PRESERVATION设计"></a>SELF PRESERVATION设计</h2><p>​        在分布式系统设计里面，通常需要对应用实例的存活进行健康检查，比较关键的问题是要处理好网络抖动或短暂不可用时造成的误判。另外Eureka Server端与Client端之间如果出现网络分区问题，在极端情况下会使得Eureka Server清空部分服务的实例列表，这个将严重影响到Eureka Server的Availability属性。因此Erueka Server引入了SELF PRESERVATION机制。<br>​        Eureka  Client端与Server端之间有个租约，Client要定时发送心跳来维持这个租约，表示自己还存活着。Eureka通过当前注册的实倒数，去计算每分钟应该从应用实例接收到的心跳数，如果最近一分钟接收到的续约的次数小于等于指定阀值的话，则关闭租约失效剔除，禁止定时任务剔除失效的实例，从而保护注册信息。</p>
<h1 id="Eureka参数调优以及监控"><a href="#Eureka参数调优以及监控" class="headerlink" title="Eureka参数调优以及监控"></a>Eureka参数调优以及监控</h1><p>下面主要分为Client端和Server端两大类进行简述，Eureka的几个核心参数</p>
<h2 id="客户端参数"><a href="#客户端参数" class="headerlink" title="客户端参数"></a>客户端参数</h2><h3 id="Client端的核心参数"><a href="#Client端的核心参数" class="headerlink" title="Client端的核心参数"></a>Client端的核心参数</h3><table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">默认值</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">eureka.client.availability-zones</td>
<td align="left"></td>
<td align="left">告知Client有哪些region以及availability-zones，支持配置修改运行时生效</td>
</tr>
<tr>
<td align="left">eureka.client.filter-only-up-instances</td>
<td align="left">true</td>
<td align="left">是否过滤出InstanceStatus为UP的实例</td>
</tr>
<tr>
<td align="left">eureka.client.region</td>
<td align="left">us-east-1</td>
<td align="left">指定该应用实例所在的region，AWS datacenters适用</td>
</tr>
<tr>
<td align="left">eureka.client.register-with-eureka</td>
<td align="left">true</td>
<td align="left">是否将该应用实例注册到Eureka Server</td>
</tr>
<tr>
<td align="left">eureka.client.prefer-szme-zone-eureka</td>
<td align="left">true</td>
<td align="left">是否优先使用与该实例处于相同zone的Eureka Server</td>
</tr>
<tr>
<td align="left">eureka.client.on-demand-update-status-change</td>
<td align="left">true</td>
<td align="left">是够将本地实例状态更新通过ApplicationInfoManager实时触发同步到Eureka Server</td>
</tr>
<tr>
<td align="left">eureka.instance.metadata-map</td>
<td align="left"></td>
<td align="left">指定应用实例的元数据信息</td>
</tr>
<tr>
<td align="left">eureka.instance.prefer-ip-address</td>
<td align="left">false</td>
<td align="left">指定优先使用ip地址替代host name作为实例的hostName字段值</td>
</tr>
<tr>
<td align="left">eureka.instance.lease-expiration-duration-in-seconds</td>
<td align="left">90</td>
<td align="left">指定Eureka Client间隔多久需要向Eureka Server发送心跳来告知Eureka Server该实例还存活</td>
</tr>
</tbody></table>
<h3 id="定时任务参数"><a href="#定时任务参数" class="headerlink" title="定时任务参数"></a>定时任务参数</h3><table>
<thead>
<tr>
<th>参数</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>eureka.client.cache-refresh-executor-thread-pool-size</td>
<td>2</td>
<td>刷新缓存的CacheRefreshThread的线程池大小</td>
</tr>
<tr>
<td>eureka.client.cache-refresh-executor-exponential-back-off-bound</td>
<td>10</td>
<td>(刷新缓存)调度任务执行超时时下次的调度的延迟时间</td>
</tr>
<tr>
<td>reka.client.heartbeat-executor-thread-pool-size</td>
<td>2</td>
<td>心跳线程HeartBeatThread的线程池大小</td>
</tr>
<tr>
<td>eureka.client.heartbeat-executor-exponential-back-off-bound</td>
<td>10</td>
<td>(心跳执行)调度任务超时时下次的调度的延时时间</td>
</tr>
<tr>
<td>eureka.client.registry-fetch-interval-seconds</td>
<td>30</td>
<td>CacheRefreshThread线程调度频率</td>
</tr>
<tr>
<td>eureka.client.eureka-service-url-poll-interval-seconds</td>
<td>5*60</td>
<td>AsyncResolver.updateTask刷新Eureka Server地址的时间间隔</td>
</tr>
<tr>
<td>eureka.client.initial-instance-info-replication-interval-seconds</td>
<td>40</td>
<td>InstanceInfoReplicator将实例信息变更同步到Eureka Server的初始延时时间</td>
</tr>
<tr>
<td>eureka.client.instance-info-replication-interval-seconds</td>
<td>30</td>
<td>InstanceInfoReplicator将实例信息变更同步到Eureka Server的时间间隔</td>
</tr>
<tr>
<td>ureka.instance.lease-renewal-interval-in-seconds</td>
<td>30</td>
<td>Eureka Client向Eureka Server发送心跳的时间间隔</td>
</tr>
</tbody></table>
<h3 id="http参数"><a href="#http参数" class="headerlink" title="http参数"></a>http参数</h3><p>Eureka Client底层httpClient与Eureka Server通信，提供的先关参数</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>eureka.client.eureka-server-connect-timeout-seconds</td>
<td>5</td>
<td>连接超时时间</td>
</tr>
<tr>
<td>eureka.client.eureka-server-read-timeout-seconds</td>
<td>8</td>
<td>读超时时间</td>
</tr>
<tr>
<td>eureka.client.eureka-server-total-connections</td>
<td>200</td>
<td>连接池最大活动连接数</td>
</tr>
<tr>
<td>eureka.client.eureka-server-total-connections-per-host</td>
<td>50</td>
<td>每个host能使用的最大链接数</td>
</tr>
<tr>
<td>eureka.client.eureka-connection-idle-timeout-seconds</td>
<td>30</td>
<td>连接池中链接的空闲时间</td>
</tr>
</tbody></table>
<h2 id="服务端端参数"><a href="#服务端端参数" class="headerlink" title="服务端端参数"></a>服务端端参数</h2><p>主要包含这几类：基本参数、response cache参数、peer相参数、http参数</p>
<h3 id="基本参数"><a href="#基本参数" class="headerlink" title="基本参数"></a>基本参数</h3><table>
<thead>
<tr>
<th>参数</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>eureka.server.enable-self-perservation</td>
<td>true</td>
<td>是否开启自我保护模式</td>
</tr>
<tr>
<td>eureka.server.renewal-percent-threshold</td>
<td>0.85</td>
<td>指定每分钟需要收到续约次数的阈值</td>
</tr>
<tr>
<td>eureka.instance.registry.expected-number-of-renews-per-min</td>
<td>1</td>
<td>指定每分钟需要接收到的续约次数值，实际该值在其中被写死为count*2，另外也会被更新</td>
</tr>
<tr>
<td>eureka.server.renewal-threshold-update-interval-ms</td>
<td>15分钟</td>
<td>指定updateRenewalThreshold定时任务的调度频率，来动态更新expectedNumberOfRenewsPerMin及numberOfRenewsPerminThreshold值</td>
</tr>
<tr>
<td>eureka.server.eviction-interval-timer-in-ms</td>
<td>60*1000</td>
<td>指定EvictionTask定时任务的调度频率，用于剔除过期的实例</td>
</tr>
</tbody></table>
<h3 id="response-cache参数"><a href="#response-cache参数" class="headerlink" title="response cache参数"></a>response cache参数</h3><p>Eureka Server为了提升自身REST API接口的性能，提供了两个缓存：一个是基于ConcurrentMap的readOnlyCacheMap，一个是基于Guava Cache的readWriteCacheMap。其相关参数如下：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>eureka.server.use-read-only-response-cache</td>
<td>true</td>
<td>是否使用只读的response-cache</td>
</tr>
<tr>
<td>eureka.server.response-cache-update-interval-ms</td>
<td>30*1000</td>
<td>设置CacheUpdateTask的调度时间间隔，用于从readWriteCacheMap更新数据到readOnlyCacheMap。仅仅在eureka.server.use-read-only-response-cache为true的时候生效</td>
</tr>
<tr>
<td>eureka.server.response-cache-auto-expiration-in-seconds</td>
<td>180</td>
<td>设置readWriteCacheMap的expireAfterWrite参数，指定写入多长时间过过期</td>
</tr>
</tbody></table>
<h3 id="peer相关参数"><a href="#peer相关参数" class="headerlink" title="peer相关参数"></a>peer相关参数</h3><table>
<thead>
<tr>
<th>参数</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>eureka.server.peer-eureka-nodes-update-interval-ms</td>
<td>10分钟</td>
<td>指定peersUpdateTask调度的时间间隔，用于从配置文件刷新peerEurekaNodes节点的配置信息(‘eureka.client.serviceUrl相关zone的配置’)</td>
</tr>
<tr>
<td>eureka.server.peer-eureka-status-refresh-time-interval-ms</td>
<td>30*1000</td>
<td>指定更新peer node状态信息的时间间隔</td>
</tr>
</tbody></table>
<h3 id="http参数-1"><a href="#http参数-1" class="headerlink" title="http参数"></a>http参数</h3><p>Eureka Server需要与其他peer节点进行通信，复制实例信息，其底层使用httpClient，提供相关的参数</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>eureka.server.peer-node-connect-timeout-ms</td>
<td>200</td>
<td>连接超时时间</td>
</tr>
<tr>
<td>eureka.server.peer-node-read-timeout-ms</td>
<td>200</td>
<td>读超时时间</td>
</tr>
<tr>
<td>eureka.server.peer-node-total-connections</td>
<td>1000</td>
<td>连接池最大活动连接数</td>
</tr>
<tr>
<td>eureka.server.peer-node-total-connections-per-host</td>
<td>500</td>
<td>每个host能使用的最大连接数</td>
</tr>
<tr>
<td>eureka.server.peer-node-connection-idle-timeout-seconds</td>
<td>30</td>
<td>连接池中连接的空闲时间</td>
</tr>
</tbody></table>
<h2 id="参数调优"><a href="#参数调优" class="headerlink" title="参数调优"></a>参数调优</h2><h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><p>1.为什么服务下线了，Eureka Server接口返回的信息还会存在？</p>
<p>2.为什么服务上线了，Eureka Client不能及时获取到？</p>
<p>3.为什么会有一下提示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EMERGENCY!EUREKA MAY BE INCORRECTLY CLAIMING INSTANCES ARE UP WHEN THEY’RE NOT. RENEWALS ARE LESSER THAN THRESHOLD AND HENCE THE INSTANCES ARE NOT BEING EXPIRED JUST TO BE SAFE</span><br></pre></td></tr></table></figure>

<p>解决方法：</p>
<p>1.Eureka Server并不是强一致的，因此registry中会议保留过期的实例信息。原因如下：</p>
<ul>
<li>应用实例异常挂掉，没能在挂掉之前告知Eureka Server要下线掉该服务实例信息。这个就需要依赖Eureka Server的EvictionTask去剔除。</li>
<li>应用实例下线是有告知Eureka Server下线，但是由于Eureka Server的REST API有response cache，因此需要等待缓存过期才能更新。</li>
<li>由于Eureka Server开启并以入了SELF PRESERVATION(自我保护)模式，导致registry的信息不会因为过期而被剔除掉，直到退出SELF PRESERVATION(自我保护)模式。</li>
</ul>
<p>针对Client下线而没有通知Eureka Server的问题，可以调整EvictionTask的调度频率，比如把默认的时间间隔60s，调整为5s：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">eviction-interval-timer-in-ms:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>

<p>针对response cache的问题，可以根据情况考虑关闭readOnlyCacheMap：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">use-read-only-response-cache:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>或者调整readWriteCacheMap的过期时间：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">response-cache-auto-expiration-in-seconds:</span> <span class="number">60</span></span><br></pre></td></tr></table></figure>

<p>针对SELF PRESERVATION(自我保护)的问题，在测试环境可以将enable-self-preservation设置为false：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">enable-self-preservation:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>关闭之后会提示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">THE SELF PRESER VAT ION MODE IS TURNED OFF.  THIS MAY NOT PRO TECT INSTANCE EXPIRY IN CASE OF NETWORK&#x2F;OTHER PROBLEMS.</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RENEWALS ARE LESSER THAN THE THRESHOLD.THE SELF PRESERVATION MODE IS TURNED OFF.THIS MAY  NOT PROTECT INSTANCE EXPIRY IN CASE OF NETWORK&#x2F;OTHER PROBLEMS.</span><br></pre></td></tr></table></figure>

<p>2.针对新服务上线，Eureka Client获取不及时的问题，在测试环境，可以适当提高client端拉取Server注册信息的频率，例如下面将默认的30s改为5s：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">registry-fetch-interval-seconds:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>3.在实际生产过程中，经常会有网络抖动等问题造成服务实例与Eureka Server的心跳未能如期保持，但是服务实例本身是健康的，这个时候如果按照租约剔除机制剔除的话，会造成误判无果大范围误判的话，可能导致整个服务注册列表的大部分注册信息被删除，从而没有可用服务。Eureka为了解决这个问题引入了SELF PRESERVATION机制，当最近一分钟接收到的租约次数小于等于指定阈值的话，则关闭租约失效剔除，禁止定时任务失效的实例，从而保护注册信息。</p>
<p>在生产环境下，可以吧renewwalPercentThreshold及leaseRenewalIntervalInSeconds参数调小一点，从而提高触发SELF PRESERVATION机制的阈值。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">10</span> <span class="comment">#默认是30</span></span><br><span class="line">    <span class="attr">renewal-percent-threshold:</span> <span class="number">0.49</span>       <span class="comment">#默认是0.85</span></span><br></pre></td></tr></table></figure>

<h2 id="监控指标"><a href="#监控指标" class="headerlink" title="监控指标"></a>监控指标</h2><p>Eureka内置了基于servo的指标统计，具体在<code>com.netflix.eureka.util.EurekaMonitors</code>。Spring Boot 2.x版本改为使用Micrometer，不再支持Neflix Servo，转而支持Neflix Servo的替代品<code>Neflix Spectator</code>。不过对于Servo，可以通过<code>DefaultMonitorRegistry.getInstance().getRegisteredMonitors</code>来获取所有注册了的Monitor，进而获取其指标值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.netflix.eureka.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.netflix.appinfo.AmazonInfo;</span><br><span class="line"><span class="keyword">import</span> com.netflix.appinfo.ApplicationInfoManager;</span><br><span class="line"><span class="keyword">import</span> com.netflix.appinfo.DataCenterInfo;</span><br><span class="line"><span class="keyword">import</span> com.netflix.appinfo.AmazonInfo.MetaDataKey;</span><br><span class="line"><span class="keyword">import</span> com.netflix.appinfo.DataCenterInfo.Name;</span><br><span class="line"><span class="keyword">import</span> com.netflix.servo.DefaultMonitorRegistry;</span><br><span class="line"><span class="keyword">import</span> com.netflix.servo.annotations.DataSourceType;</span><br><span class="line"><span class="keyword">import</span> com.netflix.servo.annotations.Monitor;</span><br><span class="line"><span class="keyword">import</span> com.netflix.servo.monitor.Monitors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> EurekaMonitors &#123;</span><br><span class="line">    <span class="comment">// 自启动以来收到的总续约次数</span></span><br><span class="line">    RENEW(<span class="string">"renewCounter"</span>, <span class="string">"Number of total renews seen since startup"</span>),</span><br><span class="line">    <span class="comment">// 自启动以来收到的总取消租约次数</span></span><br><span class="line">    CANCEL(<span class="string">"cancelCounter"</span>, <span class="string">"Number of total cancels seen since startup"</span>),</span><br><span class="line">    <span class="comment">// 自启动以来查询registry的总次数</span></span><br><span class="line">    GET_ALL_CACHE_MISS(<span class="string">"getAllCacheMissCounter"</span>, <span class="string">"Number of total registery queries seen since startup"</span>),</span><br><span class="line">    <span class="comment">// 自启动以来delta查询registry的总次数</span></span><br><span class="line">    GET_ALL_CACHE_MISS_DELTA(<span class="string">"getAllCacheMissDeltaCounter"</span>, <span class="string">"Number of total registery queries for delta seen since startup"</span>),</span><br><span class="line">    <span class="comment">// 自启动以来使用remote region查询registry的总次数</span></span><br><span class="line">    GET_ALL_WITH_REMOTE_REGIONS_CACHE_MISS(<span class="string">"getAllWithRemoteRegionCacheMissCounter"</span>, <span class="string">"Number of total registry with remote region queries seen since startup"</span>),</span><br><span class="line">  <span class="comment">// 自启动以来使用remote region及delta方式查询registry的总次数</span></span><br><span class="line">  GET_ALL_WITH_REMOTE_REGIONS_CACHE_MISS_DELTA(<span class="string">"getAllWithRemoteRegionCacheMissDeltaCounter"</span>, <span class="string">"Number of total registry queries for delta with remote region seen since startup"</span>),</span><br><span class="line">    <span class="comment">// 自启动以来查询delta的总次数</span></span><br><span class="line">    GET_ALL_DELTA(<span class="string">"getAllDeltaCounter"</span>, <span class="string">"Number of total deltas since startup"</span>),</span><br><span class="line">    <span class="comment">// 自启动以来传递regions查询delta的总次数</span></span><br><span class="line">    GET_ALL_DELTA_WITH_REMOTE_REGIONS(<span class="string">"getAllDeltaWithRemoteRegionCounter"</span>, <span class="string">"Number of total deltas with remote regions since startup"</span>),</span><br><span class="line">    <span class="comment">// 自启动以来查询'/&#123;version&#125;/apps'的次数</span></span><br><span class="line">    GET_ALL(<span class="string">"getAllCounter"</span>, <span class="string">"Number of total registry queries seen since startup"</span>),</span><br><span class="line">    <span class="comment">// 自启动以来传递regions参数查询'/&#123;version&#125;/apps'的次数</span></span><br><span class="line">    GET_ALL_WITH_REMOTE_REGIONS(<span class="string">"getAllWithRemoteRegionCounter"</span>, <span class="string">"Number of total registry queries with remote regions, seen since startup"</span>),</span><br><span class="line">    <span class="comment">// 自启动以来请求/&#123;version&#125;/apps/&#123;appId&#125;的总次数</span></span><br><span class="line">    GET_APPLICATION(<span class="string">"getApplicationCounter"</span>, <span class="string">"Number of total application queries seen since startup"</span>),</span><br><span class="line">    <span class="comment">// 自启动以来register的总次数</span></span><br><span class="line">    REGISTER(<span class="string">"registerCounter"</span>, <span class="string">"Number of total registers seen since startup"</span>),</span><br><span class="line">    <span class="comment">// 自启动以来剔除过期实例的总次数</span></span><br><span class="line">    EXPIRED(<span class="string">"expiredCounter"</span>, <span class="string">"Number of total expired leases since startup"</span>),</span><br><span class="line">    <span class="comment">// 自启动以来statusUpdate的总次数</span></span><br><span class="line">    STATUS_UPDATE(<span class="string">"statusUpdateCounter"</span>, <span class="string">"Number of total admin status updates since startup"</span>),</span><br><span class="line">    <span class="comment">// 自启动以来deleteStatusOverride的总次数</span></span><br><span class="line">    STATUS_OVERRIDE_DELETE(<span class="string">"statusOverrideDeleteCounter"</span>, <span class="string">"Number of status override removals"</span>),</span><br><span class="line">    <span class="comment">// 自启动以来收到cancel请求时对应实例找不到的次数</span></span><br><span class="line">    CANCEL_NOT_FOUND(<span class="string">"cancelNotFoundCounter"</span>, <span class="string">"Number of total cancel requests on non-existing instance since startup"</span>),</span><br><span class="line">    <span class="comment">// 自启动以来收到renew请求时对应实例找不到的次数</span></span><br><span class="line">    RENEW_NOT_FOUND(<span class="string">"renewNotFoundexpiredCounter"</span>, <span class="string">"Number of total renew on non-existing instance since startup"</span>),</span><br><span class="line">    REJECTED_REPLICATIONS(<span class="string">"numOfRejectedReplications"</span>, <span class="string">"Number of replications rejected because of full queue"</span>),</span><br><span class="line">    FAILED_REPLICATIONS(<span class="string">"numOfFailedReplications"</span>, <span class="string">"Number of failed replications - likely from timeouts"</span>),</span><br><span class="line">    <span class="comment">// 由于开启rate limiter被丢弃的请求数量</span></span><br><span class="line">    RATE_LIMITED(<span class="string">"numOfRateLimitedRequests"</span>, <span class="string">"Number of requests discarded by the rate limiter"</span>),</span><br><span class="line">    <span class="comment">// 如果开启rate limiter的话，将被丢弃的请求数</span></span><br><span class="line">    RATE_LIMITED_CANDIDATES(<span class="string">"numOfRateLimitedRequestCandidates"</span>, <span class="string">"Number of requests that would be discarded if the rate limiter's throttling is activated"</span>),</span><br><span class="line">    <span class="comment">// 开启rate limiter时请求全量registry被丢弃的请求数</span></span><br><span class="line">    RATE_LIMITED_FULL_FETCH(<span class="string">"numOfRateLimitedFullFetchRequests"</span>, <span class="string">"Number of full registry fetch requests discarded by the rate limiter"</span>),</span><br><span class="line">    <span class="comment">// 如果开启rate limiter时请求全量registry将被丢弃的请求数</span></span><br><span class="line">    RATE_LIMITED_FULL_FETCH_CANDIDATES(<span class="string">"numOfRateLimitedFullFetchRequestCandidates"</span>, <span class="string">"Number of full registry fetch requests that would be discarded if the rate limiter's throttling is activated"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String myZoneCounterName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String description;</span><br><span class="line">    <span class="meta">@Monitor</span>(</span><br><span class="line">        name = <span class="string">"count"</span>,</span><br><span class="line">        type = DataSourceType.COUNTER</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong counter = <span class="keyword">new</span> AtomicLong();</span><br><span class="line">    <span class="meta">@Monitor</span>(</span><br><span class="line">        name = <span class="string">"count-minus-replication"</span>,</span><br><span class="line">        type = DataSourceType.COUNTER</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong myZoneCounter = <span class="keyword">new</span> AtomicLong();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">EurekaMonitors</span><span class="params">(String name, String description)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.description = description;</span><br><span class="line">        DataCenterInfo dcInfo = ApplicationInfoManager.getInstance().getInfo().getDataCenterInfo();</span><br><span class="line">        <span class="keyword">if</span> (dcInfo.getName() == Name.Amazon) &#123;</span><br><span class="line">            <span class="keyword">this</span>.myZoneCounterName = ((AmazonInfo)dcInfo).get(MetaDataKey.availabilityZone) + <span class="string">"."</span> + name;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.myZoneCounterName = <span class="string">"dcmaster."</span> + name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.increment(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">(<span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.counter.incrementAndGet();</span><br><span class="line">        <span class="keyword">if</span> (!isReplication) &#123;</span><br><span class="line">            <span class="keyword">this</span>.myZoneCounter.incrementAndGet();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getZoneSpecificName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.myZoneCounterName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.counter.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getZoneSpecificCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.myZoneCounter.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerAllStats</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        EurekaMonitors[] var0 = values();</span><br><span class="line">        <span class="keyword">int</span> var1 = var0.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> var2 = <span class="number">0</span>; var2 &lt; var1; ++var2) &#123;</span><br><span class="line">            EurekaMonitors c = var0[var2];</span><br><span class="line">            Monitors.registerObject(c.getName(), c);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        EurekaMonitors[] var0 = values();</span><br><span class="line">        <span class="keyword">int</span> var1 = var0.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> var2 = <span class="number">0</span>; var2 &lt; var1; ++var2) &#123;</span><br><span class="line">            EurekaMonitors c = var0[var2];</span><br><span class="line">            DefaultMonitorRegistry.getInstance().unregister(Monitors.newObjectMonitor(c.getName(), c));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Eureka实战"><a href="#Eureka实战" class="headerlink" title="Eureka实战"></a>Eureka实战</h1><h2 id="Eureka-Server在线扩容"><a href="#Eureka-Server在线扩容" class="headerlink" title="Eureka Server在线扩容"></a>Eureka Server在线扩容</h2><p>准备工作：创建cloud工程</p>
<h3 id="创建cloud-config-server子模块。"><a href="#创建cloud-config-server子模块。" class="headerlink" title="创建cloud-config-server子模块。"></a>创建cloud-config-server子模块。</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.msr.batter.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.config.server.EnableConfigServer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConfigApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置文件:<code>resources/bootstrap.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">native</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-server</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8888</span></span><br></pre></td></tr></table></figure>

<p>这里不是主要讲解<code>Spring Cloud Config</code>内容。所以对于配置文件使用native的profile，也就是使用文件来存储配置，默认是放在<code>resources/config</code>目录下。在Eureka Server和Eureka Client模块分别引入<code>spring-cloud-starter-config</code>。分别都创建一个<code>ServerController</code>和<code>ClientController</code>。</p>
<p>Eureka Client的配置文件：<code>resources/config/eureka-client.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-eureka-client1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/</span> <span class="comment"># 一个Eureka Server</span></span><br></pre></td></tr></table></figure>

<p>Eureka Server配置文件：<code>resources/config/eureka-server-peer1.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8761</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-eureka-server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">preferIpAddress:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">registerWithEureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetchRegistry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/</span> <span class="comment"># 一个Eureka Server</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">waitTimeInMsWhenSyncEmpty:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">enableSelfPreservation:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>


<h3 id="cloud-eureka-server模块"><a href="#cloud-eureka-server模块" class="headerlink" title="cloud-eureka-server模块"></a>cloud-eureka-server模块</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--    添加    --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>ServerController</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.msr.better.registry.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EurekaClientConfigBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"query"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    EurekaClientConfigBean eurekaClientConfigBean;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"eureka-server"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getEurekaServerUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> eurekaClientConfigBean.getServiceUrl();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置文件：<code>resources/bootstrap.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-eureka-server</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:8888</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">'*'</span></span><br></pre></td></tr></table></figure>

<p>配置文件：<code>resources/application.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">peer-eureka-nodes-update-interval-ms:</span> <span class="number">10000</span> <span class="comment">#默认是10分钟即600000，这里为了验证改为10秒</span></span><br></pre></td></tr></table></figure>

<h3 id="cloud-erueka-client子模块"><a href="#cloud-erueka-client子模块" class="headerlink" title="cloud-erueka-client子模块"></a>cloud-erueka-client子模块</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">		<span class="comment">&lt;!--    添加    --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>ClientController</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.msr.better.client.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.ServiceInstance;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.DiscoveryClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EurekaClientConfigBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> MaiShuRen</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-10-23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"query"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EurekaClientConfigBean clientConfigBean;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务实例信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"info"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">info</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">16</span>);</span><br><span class="line">        List&lt;String&gt; services = discoveryClient.getServices();</span><br><span class="line">        String description = discoveryClient.description();</span><br><span class="line">        <span class="keyword">int</span> order = discoveryClient.getOrder();</span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">"services"</span>, services);</span><br><span class="line">        map.put(<span class="string">"description"</span>, description);</span><br><span class="line">        map.put(<span class="string">"order"</span>, order);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据服务名称获取服务实例列表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name 服务名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"instance/&#123;name&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ServiceInstance&gt; <span class="title">getIns</span><span class="params">(@PathVariable String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> discoveryClient.getInstances(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取Eureka Server的url</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"eureka-server"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getServiceUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> clientConfigBean.getServiceUrl();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置文件：<code>resources/bootstrap.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-eureka-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:8888</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">'*'</span></span><br></pre></td></tr></table></figure>

<p>费别启动<code>cloud-config-server</code>、<code>cloud-eureka-server</code>(使用peer1的profile)、<code>cloud-eureka-client</code>。</p>
<blockquote>
<p>mvn spring-boot:run                                                          在cloud-config-server目录下执行，启动cloud-config-server服务</p>
<p>mvn spring-boot:run -Dspring-boot.run.profiles=peer1   在cloud-eureka-server目录下执行，启动cloud-eureka-server</p>
<p>mvn spring-boot:run                                                          在cloud-eureka-client目录下执行，启动cloud-eureka-client</p>
</blockquote>
<h3 id="扩容两个Eureka-Server"><a href="#扩容两个Eureka-Server" class="headerlink" title="扩容两个Eureka Server"></a>扩容两个Eureka Server</h3><p>在<code>cloud-config-server</code>下新增配置<code>cloud-eureka-server-peer2.yml</code>和<code>cloud-eureka-server-peer3.yml</code></p>
<p><strong>cloud-eureka-server-peer2.yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8762</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">preferIpAddress:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">registerWithEureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetchRegistry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/,http://localhost:8763/eureka/</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">waitTimeInMsWhenSyncEmpty:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">enableSelfPreservation:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>启动：<code>mvn spring-boot:run -Dspring-boot.run.profiles=peer2</code></p>
<p><strong>cloud-eureka-server-peer3.yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8763</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">preferIpAddress:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">registerWithEureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetchRegistry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/,http://localhost:8762/eureka/</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">waitTimeInMsWhenSyncEmpty:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">enableSelfPreservation:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>启动：mvn spring-boot:run -Dspring.profiles.active=peer3</p>
<p>修改一下<code>cloud-eureka-client.yml</code>、<code>cloud-eureka-server-peer1.yml</code>的配置文件</p>
<p><strong>cloud-eureka-server-peer1.yml的修改</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8761</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">preferIpAddress:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">registerWithEureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetchRegistry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8762/eureka/,http://localhost:8763/eureka/</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">waitTimeInMsWhenSyncEmpty:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">enableSelfPreservation:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p><strong>cloud-eureka-client.yml的修改</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-eureka-client1</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">	  <span class="attr">efaultZone:</span> <span class="string">http://localhost:8761/eureka/,http://localhost:8762/eureka/,http://localhost:8763/eureka/</span></span><br></pre></td></tr></table></figure>

<p>然后重新启动<code>cloud-config-server</code>，使修改的配置生效。然后使用Postman这类型工具通过<code>POST请求</code>去访问<a href="http://localhost:8081/actuator/refresh、http://localhost:8761/actuator/refresh，分别刷新`cloud-eureka-client`和`cloud-eureka-server-peer1`。或者使用下面的命令" target="_blank" rel="noopener">http://localhost:8081/actuator/refresh、http://localhost:8761/actuator/refresh，分别刷新`cloud-eureka-client`和`cloud-eureka-server-peer1`。或者使用下面的命令</a></p>
<blockquote>
<p>curl -i -X POST localhost:8081/actuator/refresh</p>
<p>curl -i -X POST localhost:8761/actuator/refresh</p>
</blockquote>
<p>然后在浏览器或者使用curl命令去请求，之前<code>cloud-config-server</code>写好的一个接口：<a href="http://localhost:8081/query/eureka-server。最后返回结果：" target="_blank" rel="noopener">http://localhost:8081/query/eureka-server。最后返回结果：</a></p>
<blockquote>
<p> {“defaultZone”: “<a href="http://localhost:8761/eureka/,http://localhost:8762/eureka/,http://localhost:8763/eureka/&quot;}" target="_blank" rel="noopener">http://localhost:8761/eureka/,http://localhost:8762/eureka/,http://localhost:8763/eureka/&quot;}</a></p>
</blockquote>
<p>结果显示扩容成功</p>
<h3 id="扩容小结"><a href="#扩容小结" class="headerlink" title="扩容小结"></a>扩容小结</h3><p>对于配置文件：在扩容中使用了<code>spring-cloud-config</code>这个项目统一来管理所有服务的配置文件。在真实的使用中，这些配置文件可以放在像<code>gitlab</code>、<code>github</code>这类型的git平台上，在修改了配置之后，不需要重启配置中心。只需要通过消息总线去通知各个服务去获取最新的配置。</p>
<p>对于扩容的实例：在配置中心中配好了，新增的实例的配置信息之后。通过命令去启动打包好的springbot项目的jar包，列如：<code>java -jar cloud-eureka-server --spring.profiles.active=peer2</code>。最后刷新正在运行的实例。</p>
<h2 id="构建多zone的Eureka-Server集群"><a href="#构建多zone的Eureka-Server集群" class="headerlink" title="构建多zone的Eureka Server集群"></a>构建多zone的Eureka Server集群</h2><h3 id="创建cloud-eureka-server-multizone模块"><a href="#创建cloud-eureka-server-multizone模块" class="headerlink" title="创建cloud-eureka-server-multizone模块"></a>创建cloud-eureka-server-multizone模块</h3><p>这里启动四个Eureka Server实例。配置两个zone：zone1和zone2，每一个zone都有两个Eureka Server实例，这两个实例配置在同一个的region：region-beijing上。</p>
<p>启动类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaServerMultiApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaServerMultiApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置文件：</p>
<p>application-zone1a.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8761</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">preferIpAddress:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">metadataMap.zone:</span> <span class="string">zone1</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">region-beijing</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">zone1:</span> <span class="string">http://localhost:8761/eureka/,http://localhost:8762/eureka/</span></span><br><span class="line">      <span class="attr">zone2:</span> <span class="string">http://localhost:8763/eureka/,http://localhost:8764/eureka/</span></span><br><span class="line">    <span class="attr">availability-zones:</span></span><br><span class="line">      <span class="attr">region-beijing:</span> <span class="string">zone1,zone2</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">waitTimeInMsWhenSyncEmpty:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">enableSelfPreservation:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>application-zone1b.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8762</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">preferIpAddress:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">metadataMap.zone:</span> <span class="string">zone1</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">region-beijing</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">zone1:</span> <span class="string">http://localhost:8761/eureka/,http://localhost:8762/eureka/</span></span><br><span class="line">      <span class="attr">zone2:</span> <span class="string">http://localhost:8763/eureka/,http://localhost:8764/eureka/</span></span><br><span class="line">    <span class="attr">availability-zones:</span></span><br><span class="line">      <span class="attr">region-beijing:</span> <span class="string">zone1,zone2</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">waitTimeInMsWhenSyncEmpty:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">enableSelfPreservation:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>application-zone2a.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8763</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">preferIpAddress:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">metadataMap.zone:</span> <span class="string">zone2</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">region-beijing</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">zone1:</span> <span class="string">http://localhost:8761/eureka/,http://localhost:8762/eureka/</span></span><br><span class="line">      <span class="attr">zone2:</span> <span class="string">http://localhost:8763/eureka/,http://localhost:8764/eureka/</span></span><br><span class="line">    <span class="attr">availability-zones:</span></span><br><span class="line">      <span class="attr">region-beijing:</span> <span class="string">zone1,zone2</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">waitTimeInMsWhenSyncEmpty:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">enableSelfPreservation:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>application-zone2b.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8764</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">preferIpAddress:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">metadataMap.zone:</span> <span class="string">zone2</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">region-beijing</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">zone1:</span> <span class="string">http://localhost:8761/eureka/,http://localhost:8762/eureka/</span></span><br><span class="line">      <span class="attr">zone2:</span> <span class="string">http://localhost:8763/eureka/,http://localhost:8764/eureka/</span></span><br><span class="line">    <span class="attr">availability-zones:</span></span><br><span class="line">      <span class="attr">region-beijing:</span> <span class="string">zone1,zone2</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">waitTimeInMsWhenSyncEmpty:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">enableSelfPreservation:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">use-read-only-response-cache:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">response-cache-auto-expiration-in-seconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">'*'</span></span><br></pre></td></tr></table></figure>

<p>在上面的四个配置可以看得出，每一个Eureka instance都配置了自己的zone：<code>ereuka.instance.metadataMap.zone</code>。那么接下来启动它们看一下：随便访问一个Eureka Server</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mvn spring-boot:run -Dspring-boot.run.profiles=zone1a</span><br><span class="line">mvn spring-boot:run -Dspring-boot.run.profiles=zone1b</span><br><span class="line">mvn spring-boot:run -Dspring-boot.run.profiles=zone2a</span><br><span class="line">mvn spring-boot:run -Dspring-boot.run.profiles=zone2b</span><br></pre></td></tr></table></figure>

<h3 id="创建cloud-eureka-client-multizone模块"><a href="#创建cloud-eureka-client-multizone模块" class="headerlink" title="创建cloud-eureka-client-multizone模块"></a>创建cloud-eureka-client-multizone模块</h3><p>创建次模块获取Eureka Server信息。</p>
<p>配置文件<br>application-znoe1.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-client</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">metadataMap.zone:</span> <span class="string">zone1</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">region-beijing</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">zone1:</span> <span class="string">http://localhost:8761/eureka/,http://localhost:8762/eureka/</span></span><br><span class="line">      <span class="attr">zone2:</span> <span class="string">http://localhost:8763/eureka/,http://localhost:8764/eureka/</span></span><br><span class="line">    <span class="attr">availability-zones:</span></span><br><span class="line">      <span class="attr">region-beijing:</span> <span class="string">zone1,zone2</span></span><br></pre></td></tr></table></figure>

<p>application-znoe2.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-client</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">metadataMap.zone:</span> <span class="string">zone2</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">region-beijing</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">zone1:</span> <span class="string">http://localhost:8761/eureka/,http://localhost:8762/eureka/</span></span><br><span class="line">      <span class="attr">zone2:</span> <span class="string">http://localhost:8763/eureka/,http://localhost:8764/eureka/</span></span><br><span class="line">    <span class="attr">availability-zones:</span></span><br><span class="line">      <span class="attr">region-beijing:</span> <span class="string">zone1,zone2</span></span><br></pre></td></tr></table></figure>

<p>application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">'*'</span></span><br></pre></td></tr></table></figure>

<p>启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaClientMultiApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaClientMultiApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动zone1和zone2这两个配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mvn spring-boot:run -Dspring-boot.run.profiles=zone1</span><br><span class="line">mvn spring-boot:run -Dspring-boot.run.profiles=zone2</span><br></pre></td></tr></table></figure>

<h3 id="创建cloud-zuul-gateway"><a href="#创建cloud-zuul-gateway" class="headerlink" title="创建cloud-zuul-gateway"></a>创建cloud-zuul-gateway</h3><p>创建一个zuul实例来演示Eureka使用metadataMap的zone属性时ZoneAffinity特性</p>
<p><strong>代码</strong></p>
<p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.msr.better<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-zuul-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZuulApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ZuulApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置文件</p>
<p>application-zone1.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10001</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">metadataMap.zone:</span> <span class="string">zone1</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">region-beijing</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">zone1:</span> <span class="string">http://localhost:8761/eureka/,http://localhost:8762/eureka/</span></span><br><span class="line">      <span class="attr">zone2:</span> <span class="string">http://localhost:8763/eureka/,http://localhost:8764/eureka/</span></span><br><span class="line">    <span class="attr">availability-zones:</span></span><br><span class="line">      <span class="attr">region-beijing:</span> <span class="string">zone1,zone2</span></span><br></pre></td></tr></table></figure>

<p>application-zone2.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10002</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">metadataMap.zone:</span> <span class="string">zone2</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">region-beijing</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">zone1:</span> <span class="string">http://localhost:8761/eureka/,http://localhost:8762/eureka/</span></span><br><span class="line">      <span class="attr">zone2:</span> <span class="string">http://localhost:8763/eureka/,http://localhost:8764/eureka/</span></span><br><span class="line">    <span class="attr">availability-zones:</span></span><br><span class="line">      <span class="attr">region-beijing:</span> <span class="string">zone1,zone2</span></span><br></pre></td></tr></table></figure>

<p>application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">zuul-gateway</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">'*'</span></span><br></pre></td></tr></table></figure>

<p>启动这两个配置的zuul实例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mvn spring-boot:run -Dspring-boot.run.profiles=zone1</span><br><span class="line">mvn spring-boot:run -Dspring-boot.run.profiles=zone2</span><br></pre></td></tr></table></figure>

<h3 id="测试验证"><a href="#测试验证" class="headerlink" title="测试验证"></a>测试验证</h3><p>浏览器访问：<a href="http://localhost/eureka-client/actuator/env和http://localhost:10002/eureka-client/actuator/env。分别会返回。" target="_blank" rel="noopener">http://localhost/eureka-client/actuator/env和http://localhost:10002/eureka-client/actuator/env。分别会返回。</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"activeProfiles"</span>: [</span><br><span class="line">        <span class="string">"zone1"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"propertySources"</span>: [...]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"activeProfiles"</span>: [</span><br><span class="line">        <span class="string">"zone2"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"propertySources"</span>: [...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从结果可以看得出来，通过请求gateway的eureka-clienti/actuator/env，访问的是eureka-client实例的/actuator/env接口，处于zone1的gateway返回的activeProfiles为zone1，处于zone2的gateway返回的activeProfiles为zone2。从这个表象看gateway路由时对client的实例是ZoneAffinity的。</p>
<h2 id="支持Remote-Region"><a href="#支持Remote-Region" class="headerlink" title="支持Remote Region"></a>支持Remote Region</h2><p>一下模块的maven坐标和启动类和上面基本一致。代码就不贴出来了。</p>
<h3 id="创建cloud-eureka-server-remote-region模块"><a href="#创建cloud-eureka-server-remote-region模块" class="headerlink" title="创建cloud-eureka-server-remote-region模块"></a>创建cloud-eureka-server-remote-region模块</h3><p>配置四个Eureka Server，分四个zone。zone1、zone2属于region-beijing；zone3、zone4属于region-guangzhou。region-beijing和region-guangzhou互为remote-region</p>
<p>配置文件</p>
<p>application-zone1.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8761</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">waitTimeInMsWhenSyncEmpty:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">enableSelfPreservation:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">remoteRegionUrlsWithName:</span></span><br><span class="line">      <span class="attr">region-guangzhou:</span> <span class="string">http://localhost:8763/eureka/</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">region-beijing</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">zone1:</span> <span class="string">http://localhost:8761/eureka/</span></span><br><span class="line">      <span class="attr">zone2:</span> <span class="string">http://localhost:8762/eureka/</span></span><br><span class="line">    <span class="attr">availability-zones:</span></span><br><span class="line">      <span class="attr">region-beijing:</span> <span class="string">zone1,zone2</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">metadataMap.zone:</span> <span class="string">zone1</span></span><br></pre></td></tr></table></figure>

<p>application-zone2.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8762</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">waitTimeInMsWhenSyncEmpty:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">enableSelfPreservation:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">remoteRegionUrlsWithName:</span></span><br><span class="line">      <span class="attr">region-guangzhou:</span> <span class="string">http://localhost:8763/eureka/</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">region-beijing</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">zone1:</span> <span class="string">http://localhost:8761/eureka/</span></span><br><span class="line">      <span class="attr">zone2:</span> <span class="string">http://localhost:8762/eureka/</span></span><br><span class="line">    <span class="attr">availability-zones:</span></span><br><span class="line">      <span class="attr">region-beijing:</span> <span class="string">zone1,zone2</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">metadataMap.zone:</span> <span class="string">zone2</span></span><br></pre></td></tr></table></figure>

<p>application-zone3-region-guangzhou.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8763</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">waitTimeInMsWhenSyncEmpty:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">enableSelfPreservation:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">remoteRegionUrlsWithName:</span></span><br><span class="line">      <span class="attr">region-beijing:</span> <span class="string">http://localhost:8761/eureka/</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">region-guangzhou</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">zone3:</span> <span class="string">http://localhost:8763/eureka/</span></span><br><span class="line">      <span class="attr">zone4:</span> <span class="string">http://localhost:8764/eureka/</span></span><br><span class="line">    <span class="attr">availability-zones:</span></span><br><span class="line">      <span class="attr">region-guangzhou:</span> <span class="string">zone3,zone4</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">metadataMap.zone:</span> <span class="string">zone3</span></span><br></pre></td></tr></table></figure>

<p>application-zone4-region-guangzhou.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8764</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">waitTimeInMsWhenSyncEmpty:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">enableSelfPreservation:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">remoteRegionUrlsWithName:</span></span><br><span class="line">      <span class="attr">region-beijing:</span> <span class="string">http://localhost:8761/eureka/</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">region-guangzhou</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">zone3:</span> <span class="string">http://localhost:8763/eureka/</span></span><br><span class="line">      <span class="attr">zone4:</span> <span class="string">http://localhost:8764/eureka/</span></span><br><span class="line">    <span class="attr">availability-zones:</span></span><br><span class="line">      <span class="attr">region-guangzhou:</span> <span class="string">zone3,zone4</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">metadataMap.zone:</span> <span class="string">zone4</span></span><br></pre></td></tr></table></figure>

<p>创建配置类：RegionConfig。因为zone3和zone4是属于region-guangzhou，remote-region配置为region-beijing。由于源码里EurekaServerConfigBean的remoteRegionAppWhitelist默认为null；而getRemoteRegionAppWhitelist(String regionName)方法会直接被调用，如果不设置会导致空指针异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@AutoConfigureBefore</span>(EurekaServerAutoConfiguration<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">RegionConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EurekaServerConfig <span class="title">eurekaServerConfig</span><span class="params">(EurekaClientConfig clientConfig)</span> </span>&#123;</span><br><span class="line">        EurekaServerConfigBean serverConfigBean = <span class="keyword">new</span> EurekaServerConfigBean();</span><br><span class="line">        <span class="keyword">if</span> (clientConfig.shouldRegisterWithEureka()) &#123;</span><br><span class="line">            serverConfigBean.setRegistrySyncRetries(<span class="number">6</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        serverConfigBean.setRemoteRegionAppWhitelist(<span class="keyword">new</span> HashMap&lt;&gt;());</span><br><span class="line">        <span class="keyword">return</span> serverConfigBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动Eureka Server：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mvn spring-boot:run -Dspring-boot.run.profiles=zone1</span><br><span class="line">mvn spring-boot:run -Dspring-boot.run.profiles=zone2</span><br><span class="line">mvn spring-boot:run -Dspring-boot.run.profiles=zone3-region-guangzhou</span><br><span class="line">mvn spring-boot:run -Dspring-boot.run.profiles=zone4-region-guangzhou</span><br></pre></td></tr></table></figure>

<h3 id="创建cloud-eureka-client-remote-region模块"><a href="#创建cloud-eureka-client-remote-region模块" class="headerlink" title="创建cloud-eureka-client-remote-region模块"></a>创建cloud-eureka-client-remote-region模块</h3><p>四个client，分为四个zone，属于region-beijng和region-guangzhou这两个region。</p>
<p><strong>配置文件</strong></p>
<p>application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">'*'</span></span><br></pre></td></tr></table></figure>

<p>application-zone1.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8071</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application.name:</span> <span class="string">eureka-client</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">prefer-same-zone-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">region-beijing</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">zone1:</span> <span class="string">http://localhost:8761/eureka/</span></span><br><span class="line">      <span class="attr">zone2:</span> <span class="string">http://localhost:8762/eureka/</span></span><br><span class="line">    <span class="attr">availability-zones:</span></span><br><span class="line">      <span class="attr">region-beijing:</span> <span class="string">zone1,zone2</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">metadataMap.zone:</span> <span class="string">zone1</span></span><br></pre></td></tr></table></figure>

<p>application-zone2.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8072</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application.name:</span> <span class="string">eureka-client</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">prefer-same-zone-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">region-beijing</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">zone1:</span> <span class="string">http://localhost:8761/eureka/</span></span><br><span class="line">      <span class="attr">zone2:</span> <span class="string">http://localhost:8762/eureka/</span></span><br><span class="line">    <span class="attr">availability-zones:</span></span><br><span class="line">      <span class="attr">region-beijing:</span> <span class="string">zone1,zone2</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">metadataMap.zone:</span> <span class="string">zone2</span></span><br></pre></td></tr></table></figure>

<p>application-zone3.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8073</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application.name:</span> <span class="string">eureka-client</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">prefer-same-zone-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">region-guangzhou</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">zone3:</span> <span class="string">http://localhost:8763/eureka/</span></span><br><span class="line">      <span class="attr">zone4:</span> <span class="string">http://localhost:8764/eureka/</span></span><br><span class="line">    <span class="attr">availability-zones:</span></span><br><span class="line">      <span class="attr">region-guangzhou:</span> <span class="string">zone3,zone4</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">metadataMap.zone:</span> <span class="string">zone3</span></span><br></pre></td></tr></table></figure>

<p>application-zone4.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8074</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application.name:</span> <span class="string">eureka-client</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">prefer-same-zone-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">region-guangzhou</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">zone3:</span> <span class="string">http://localhost:8763/eureka/</span></span><br><span class="line">      <span class="attr">zone4:</span> <span class="string">http://localhost:8764/eureka/</span></span><br><span class="line">    <span class="attr">availability-zones:</span></span><br><span class="line">      <span class="attr">region-guangzhou:</span> <span class="string">zone3,zone4</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">metadataMap.zone:</span> <span class="string">zone4</span></span><br></pre></td></tr></table></figure>

<p><strong>启动</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mvn spring-boot:run -Dspring-boot.run.profiles=zone1</span><br><span class="line">mvn spring-boot:run -Dspring-boot.run.profiles=zone2</span><br><span class="line">mvn spring-boot:run -Dspring-boot.run.profiles=zone3</span><br><span class="line">mvn spring-boot:run -Dspring-boot.run.profiles=zone4</span><br></pre></td></tr></table></figure>

<h3 id="创建cloud-zuul-gateway-remote-region模块"><a href="#创建cloud-zuul-gateway-remote-region模块" class="headerlink" title="创建cloud-zuul-gateway-remote-region模块"></a>创建cloud-zuul-gateway-remote-region模块</h3><p>配置文件</p>
<p>application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">zuul-gateway</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">'*'</span></span><br></pre></td></tr></table></figure>

<p>application-zone1.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10001</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">metadataMap.zone:</span> <span class="string">zone1</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">region-beijing</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">zone1:</span> <span class="string">http://localhost:8761/eureka/</span></span><br><span class="line">      <span class="attr">zone2:</span> <span class="string">http://localhost:8762/eureka/</span></span><br><span class="line">    <span class="attr">availability-zones:</span></span><br><span class="line">      <span class="attr">region-beijing:</span> <span class="string">zone1,zone2</span></span><br></pre></td></tr></table></figure>

<p>application-zone3-region-guangzhou.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10002</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">metadataMap.zone:</span> <span class="string">zone3</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">region-guangzhou</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">zone3:</span> <span class="string">http://localhost:8763/eureka/</span></span><br><span class="line">      <span class="attr">zone4:</span> <span class="string">http://localhost:8764/eureka/</span></span><br><span class="line">    <span class="attr">availability-zones:</span></span><br><span class="line">      <span class="attr">region-guangzhou:</span> <span class="string">zone3,zone4</span></span><br></pre></td></tr></table></figure>

<p>启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mvn spring-boot:run -Dspring-boot.run.profiles=zone1</span><br><span class="line">mvn spring-boot:run -Dspring-boot.run.profiles=zone3-region-guangzhou</span><br></pre></td></tr></table></figure>

<h3 id="测试验证-1"><a href="#测试验证-1" class="headerlink" title="测试验证"></a>测试验证</h3><p>在全部启动完成之后，分别访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:10001&#x2F;eureka-client&#x2F;actuator&#x2F;env</span><br><span class="line">http:&#x2F;&#x2F;localhost:10002&#x2F;eureka-client&#x2F;actuator&#x2F;env</span><br></pre></td></tr></table></figure>

<p>10001端口的网关访问的是zone1的eureka-client。10002端口的网关访问的是zone3的eureka-client。现在关掉zone1和zone2的eureka-client，继续访问<code>http://localhost:10001/eureka-client/actuator/env</code>，在报错几次之后，就会自动fallback切换到remote-region里的zone。实现了类似于异地多活自动转义请求的效果。</p>
<h2 id="开启HTTP-Basic认证"><a href="#开启HTTP-Basic认证" class="headerlink" title="开启HTTP Basic认证"></a>开启HTTP Basic认证</h2><p>Eureka Server是有暴露了自己的REST API，如果没有安全认证，别人就可以通过这些API修改信息，造成服务异常。那就看一下Euerka Server是怎么开启使用HTTP Basic校验，以及Eureka Client是怎么鉴权的。</p>
<h3 id="创建cloud-eureka-server-http-basic模块"><a href="#创建cloud-eureka-server-http-basic模块" class="headerlink" title="创建cloud-eureka-server-http-basic模块"></a>创建cloud-eureka-server-http-basic模块</h3><p>pom.xml.。引入<code>spring-boot-starter-security</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.msr.better<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-eureka-server-http-basic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>application.yml。很明显我们在配置文件中配置了用户名和密码，这些配置config-server这些配置中心来使用更加适合。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8761</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">basic:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">admin</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">Xk38CNHigBP5jK75</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">registerWithEureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">fetchRegistry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">waitTimeInMsWhenSyncEmpty:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">enableSelfPreservation:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>禁用<code>spring-boot-starter-security</code>默认开启的csrf功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.configure(http);</span><br><span class="line">        http.csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在浏览器访问<a href="http://localhost:8761或http://localhost:8761/eureka/apps，这些eureka的REST">http://localhost:8761或http://localhost:8761/eureka/apps，这些eureka的REST</a> API时，是要求登录的。使用在配置文件中配置好的username和password登录，才可以成功访问。</p>
<h3 id="创建cloud-eureka-client-http-basic模块"><a href="#创建cloud-eureka-client-http-basic模块" class="headerlink" title="创建cloud-eureka-client-http-basic模块"></a>创建cloud-eureka-client-http-basic模块</h3><p>因为Eureka Server开启了HTTP Basic认证，所以Eureka Client需要配置相对应的用户名和密码。同样这里在配置文件中配置，当然配置config-server使用更好。</p>
<p><strong>配置文件</strong></p>
<p>application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">client1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">security:</span></span><br><span class="line">      <span class="attr">basic:</span></span><br><span class="line">        <span class="attr">user:</span> <span class="string">admin</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">Xk38CNHigBP5jK75</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://$&#123;eureka.client.security.basic.user&#125;:$&#123;eureka.client.security.basic.password&#125;@localhost:8761/eureka/</span></span><br><span class="line">      <span class="comment">#defaultZone: http://localhost:8761/eureka/</span></span><br></pre></td></tr></table></figure>

<p>如果不使用用户名密码的话启动会报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Request execution failure with status code 401; retrying on another server if available</span><br></pre></td></tr></table></figure>

<p>浏览器登录之后，访问<a href="http://localhost:8761/eureka/apps。可以看到注册进去的eureka-client实例的信息，说明注册成功。" target="_blank" rel="noopener">http://localhost:8761/eureka/apps。可以看到注册进去的eureka-client实例的信息，说明注册成功。</a></p>
<h2 id="启用https"><a href="#启用https" class="headerlink" title="启用https"></a>启用https</h2><p>虽然开启了HTTP Basic但是基于base64编码很容易抓包被破解，如果直接暴露在公网上很危险。因此Eureka Server和Client开启https可以有效的解决这类问题。</p>
<h3 id="证书准备"><a href="#证书准备" class="headerlink" title="证书准备"></a>证书准备</h3><p>1、生成证书</p>
<p>使用jdk的keytool工具</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -genkeypair -alias server -storetype PKCS12 -keyalg RSA -keysize 2048 -keystore eureka.server -validity 365</span><br></pre></td></tr></table></figure>

<p>上面的命令生成server端的证书，密码是server</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -genkeypair -alias client -storetype PKCS12 -keyalg RSA -keysize 2048 -keystore eureka.client -validity 365</span><br></pre></td></tr></table></figure>

<p>上面的命令生成client端的证书，密码是client</p>
<p>2、导出证书</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">导出server</span></span><br><span class="line">keytool -export -alias server -file server.crt --keystore eureka.server</span><br><span class="line"><span class="meta">#</span><span class="bash">导出client</span></span><br><span class="line">keytool -export -alias client -file client.crt --keystore eureka.client</span><br></pre></td></tr></table></figure>

<p>3、使Client端信任Server</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 提示输入密码时，输入client的密码：Client</span></span><br><span class="line">keytool -import -alias server -file server.crt --keystore eureka.client</span><br></pre></td></tr></table></figure>

<p>4、使Server信任Client</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 同理</span></span><br><span class="line">keytool -import -alias client -file client.crt --keystore eureka.server</span><br></pre></td></tr></table></figure>

<h3 id="创建cloud-eureka-server-https模块"><a href="#创建cloud-eureka-server-https模块" class="headerlink" title="创建cloud-eureka-server-https模块"></a>创建cloud-eureka-server-https模块</h3><p>把生成的server.crt、client.crt和eureka.server复制到resources文件夹下。</p>
<p>配置文件</p>
<p>application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8761</span></span><br><span class="line">  <span class="attr">ssl:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">key-store:</span> <span class="string">classpath:eureka.server</span></span><br><span class="line">    <span class="attr">key-store-password:</span> <span class="string">server</span></span><br><span class="line">    <span class="attr">key-store-type:</span> <span class="string">PKCS12</span></span><br><span class="line">    <span class="attr">key-alias:</span> <span class="string">server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">securePort:</span> <span class="string">$&#123;server.port&#125;</span></span><br><span class="line">    <span class="attr">securePortEnabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">nonSecurePortEnabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">homePageUrl:</span> <span class="string">https://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/</span></span><br><span class="line">    <span class="attr">statusPageUrl:</span> <span class="string">https://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">registerWithEureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">fetchRegistry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">https://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">waitTimeInMsWhenSyncEmpty:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">enableSelfPreservation:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>启动之后，分别在浏览器访问<a href="http://localhost:8761和https://localhost:8761。使用http访问的时候会出现">http://localhost:8761和https://localhost:8761。使用http访问的时候会出现</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Bad Request</span><br><span class="line">This combination of host and port requires TLS.</span><br></pre></td></tr></table></figure>

<p>使用https访问时正确的访问到了eureka。说明https启用成功</p>
<h3 id="创建cloud-eureka-client-https模块"><a href="#创建cloud-eureka-client-https模块" class="headerlink" title="创建cloud-eureka-client-https模块"></a>创建cloud-eureka-client-https模块</h3><p>把生成的server.crt、client.crt和eureka.client复制到resources文件夹下。</p>
<p>pom.xml，添加httpclient</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.5.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置文件</p>
<p>application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-client1</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">securePortEnabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">ssl:</span></span><br><span class="line">      <span class="attr">key-store:</span> <span class="string">eureka.client</span></span><br><span class="line">      <span class="attr">key-store-password:</span> <span class="string">client</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">https://localhost:8761/eureka/</span></span><br></pre></td></tr></table></figure>

<p>在上面的配置文件中，没有配置整个应用开启https，因为这里仅仅是Eureka Server开启了https。通过自定义eureka.client.key-store以及eureka.client.ssl.key.store-password，来执行Eureka Client访问Eureka Server的sslContext配置，所以需要配置一下DiscoveryClient。</p>
<p>最后，启动就可以在Eureka Server上看到注册的Eureka Client了。</p>
<h2 id="Eureka-Admin"><a href="#Eureka-Admin" class="headerlink" title="Eureka Admin"></a>Eureka Admin</h2><p>在微服务架构中注册中心是必不可少的基础组件，Eureka Server是Spring Cloud技术栈中的基础组件。Spring Cloud中国社区开源了一个对Eureka Server节点进行监控、服务动态启停的管控平台：Eureka Admin。Github上的地址：<a href="https://github.com/SpringCloud/eureka-admin。在Github上看见这个仓库最新的更新：Updated" target="_blank" rel="noopener">https://github.com/SpringCloud/eureka-admin。在Github上看见这个仓库最新的更新：Updated</a> on 15 Aug 2019，现在国内用的最多的是Spring Cloud Alibaba Nacos，毕竟Eureka2.x版本已经停止开源了，但是Eureka1.x版本还在持续的维护中。可能Alibaba就是看到了这一点强势开源了Spring Cloud Alibaba，其中的Nacos确实解决了一些“痛点”。</p>
<p>现在来看一下，Eureka Admin！</p>
<p>构建步骤：<br>1、正常启动您的Eureka以及服务体系<br>2、由于目前尚未提交中央仓库，需下载源码构建地址：<a href="https://github.com/SpringCloud/eureka-admin，打开eureka-admin-starter-server项目配置文件，设置您的eureka注册中心地址以及eureka-admin管控平台端口即可，如下" target="_blank" rel="noopener">https://github.com/SpringCloud/eureka-admin，打开eureka-admin-starter-server项目配置文件，设置您的eureka注册中心地址以及eureka-admin管控平台端口即可，如下</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">server:</span> </span><br><span class="line">    <span class="attr">eviction-interval-timer-in-ms:</span> <span class="number">30000</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">filterOnlyUpInstances:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">       <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/,http://localhost:8762/eureka/,http://localhost:8763/eureka/,http://localhost:8764/eureka/</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com:</span></span><br><span class="line">      <span class="attr">itopener:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="attr">org:</span></span><br><span class="line">      <span class="attr">springframework:</span> <span class="string">INFO</span></span><br></pre></td></tr></table></figure>

<p>3、启动EurekaAdminServer。浏览器访问：<a href="http://localhost:8080" target="_blank" rel="noopener">http://localhost:8080</a></p>
<p>4、结果</p>
<p>![](<a href="https://cdn.jsdelivr.net/gh/MaiSR9527/blog-pic/springcloud/eureka" target="_blank" rel="noopener">https://cdn.jsdelivr.net/gh/MaiSR9527/blog-pic/springcloud/eureka</a> admin-1.png)</p>
<p>![](<a href="https://cdn.jsdelivr.net/gh/MaiSR9527/blog-pic/springcloud/eureka" target="_blank" rel="noopener">https://cdn.jsdelivr.net/gh/MaiSR9527/blog-pic/springcloud/eureka</a> admin-2.png)</p>
<p>这个估计也就了解一下吧，或者二次开发。</p>
<h1 id="Eureka故障演练"><a href="#Eureka故障演练" class="headerlink" title="Eureka故障演练"></a>Eureka故障演练</h1><h2 id="Eureka-Server全部不可用"><a href="#Eureka-Server全部不可用" class="headerlink" title="Eureka Server全部不可用"></a>Eureka Server全部不可用</h2><h3 id="启动前全部不可用"><a href="#启动前全部不可用" class="headerlink" title="启动前全部不可用"></a>启动前全部不可用</h3><p>如果Eureka Server集群在其他需要注册的服务还没启动之前就全部挂掉了或者没有启动，客户端就会一直报错。因为客户端一直连接不上Eureka Server，访问不了service registry的服务信息，不能和其他的服务交互。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">2021-04-07 11:02:28.734 ERROR 13120 --- [           main] c.n.d.s.t.d.RedirectingEurekaHttpClient  : Request execution error. endpoint&#x3D;DefaultEn</span><br><span class="line">dpoint&#123; serviceUrl&#x3D;&#39;http:&#x2F;&#x2F;localhost:8762&#x2F;eureka&#x2F;&#125;</span><br><span class="line"></span><br><span class="line">com.sun.jersey.api.client.ClientHandlerException: java.net.ConnectException: Connection refused: connect</span><br><span class="line">        at com.sun.jersey.client.apache4.ApacheHttpClient4Handler.handle(ApacheHttpClient4Handler.java:187) ~[jersey-apache-client4-1.19.1.jar:1</span><br><span class="line">.19.1]</span><br><span class="line">        at com.sun.jersey.api.client.filter.GZIPContentEncodingFilter.handle(GZIPContentEncodingFilter.java:123) ~[jersey-client-1.19.1.jar:1.19</span><br><span class="line">.1]</span><br><span class="line">        at com.netflix.discovery.EurekaIdentityHeaderFilter.handle(EurekaIdentityHeaderFilter.java:27) ~[eureka-client-1.9.17.jar:1.9.17]</span><br><span class="line">        at com.sun.jersey.api.client.Client.handle(Client.java:652) ~[jersey-client-1.19.1.jar:1.19.1]</span><br><span class="line">        at com.sun.jersey.api.client.WebResource.handle(WebResource.java:682) ~[jersey-client-1.19.1.jar:1.19.1]</span><br><span class="line">        at com.sun.jersey.api.client.WebResource.access$200(WebResource.java:74) ~[jersey-client-1.19.1.jar:1.19.1]</span><br><span class="line">        at com.sun.jersey.api.client.WebResource$Builder.get(WebResource.java:509) ~[jersey-client-1.19.1.jar:1.19.1]</span><br></pre></td></tr></table></figure>

<p>针对以上这种情况，Eureka Server设计了一个eureka.client.backup-registry-impl属性，配置之后可以防止在启动时访问不到Eureka Server的情况，这样客户端就可以访问这个back registry，作为一个fallback处理。改backup-registry-impl比较适合服务端提供负载均衡或者服务ip相对固定的场景。</p>
<p>在客户端添加</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(<span class="string">"staticBackupServiceRegistry"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticBackupServiceRegistry</span> <span class="keyword">implements</span> <span class="title">BackupRegistry</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Applications localApps = <span class="keyword">new</span> Applications();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StaticBackupServiceRegistry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Application application = <span class="keyword">new</span> Application(<span class="string">"org"</span>);</span><br><span class="line">        InstanceInfo instanceInfo1 = InstanceInfo.Builder.newBuilder()</span><br><span class="line">                .setAppName(<span class="string">"org-service"</span>)</span><br><span class="line">                .setVIPAddress(<span class="string">"org-service"</span>)</span><br><span class="line">                .setInstanceId(<span class="string">"org-instance-1"</span>)</span><br><span class="line">                .setHostName(<span class="string">"192.168.79.100"</span>)</span><br><span class="line">                .setIPAddr(<span class="string">"192.168.79.100"</span>)</span><br><span class="line">                .setPort(<span class="number">9090</span>)</span><br><span class="line">                .setDataCenterInfo(<span class="keyword">new</span> MyDataCenterInfo(DataCenterInfo.Name.MyOwn))</span><br><span class="line">                .setStatus(InstanceInfo.InstanceStatus.UP)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        InstanceInfo instanceInfo2 = InstanceInfo.Builder.newBuilder()</span><br><span class="line">                .setAppName(<span class="string">"org-service"</span>)</span><br><span class="line">                .setVIPAddress(<span class="string">"org-service"</span>)</span><br><span class="line">                .setInstanceId(<span class="string">"org-instance-1"</span>)</span><br><span class="line">                .setHostName(<span class="string">"192.168.79.100"</span>)</span><br><span class="line">                .setIPAddr(<span class="string">"192.168.79.100"</span>)</span><br><span class="line">                .setPort(<span class="number">9091</span>)</span><br><span class="line">                .setDataCenterInfo(<span class="keyword">new</span> MyDataCenterInfo(DataCenterInfo.Name.MyOwn))</span><br><span class="line">                .setStatus(InstanceInfo.InstanceStatus.UP)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        application.addInstance(instanceInfo1);</span><br><span class="line">        application.addInstance(instanceInfo2);</span><br><span class="line">        localApps.addApplication(application);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Applications <span class="title">fetchRegistry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> localApps;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Applications <span class="title">fetchRegistry</span><span class="params">(String[] strings)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> localApps;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">backup-registry-impl:</span> <span class="string">staticBackupServiceRegistry</span></span><br></pre></td></tr></table></figure>

<h3 id="运行时全部不可用"><a href="#运行时全部不可用" class="headerlink" title="运行时全部不可用"></a>运行时全部不可用</h3><p>Eureka Client在本地内存中有一个<code>AtomicReference&lt;Applications&gt;</code>类型的localRegionApps变量，来维护从Eureka Server拉取回来的注册信息。Client端有个定时任务CacheRefeshThread，会定时从Eureka Server拉取注册信息更新到本地，如果Eureka Server在应用服务运行时挂掉了，Client端本地的CacheRefreshThread会抛出异常，本地的localRegionApps不会得到更新。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2021-04-07 11:35:37.979 ERROR 10236 --- [freshExecutor-0] c.n.d.s.t.d.RedirectingEurekaHttpClient  : Request execution error. endpoint&#x3D;DefaultEn</span><br><span class="line">dpoint&#123; serviceUrl&#x3D;&#39;http:&#x2F;&#x2F;localhost:8762&#x2F;eureka&#x2F;&#125;</span><br></pre></td></tr></table></figure>

<p>从错误日志可以看到，报错的是名为<code>freshExecutor-0</code>的线程。</p>
<h2 id="Eureka-Server部分不可用"><a href="#Eureka-Server部分不可用" class="headerlink" title="Eureka Server部分不可用"></a>Eureka Server部分不可用</h2><p>部分不可用的话，Server端和Client端都会出现错误日志。</p>
<h3 id="Server端"><a href="#Server端" class="headerlink" title="Server端"></a>Server端</h3><p>Eureka Server之前相互是peer node，如果有一台Eureka Server挂了，那么Eureka Server之间的replication会受到影响。</p>
<p>PeerEurekaNodes(com.netflix.eureka.cluster.PeerEurekaNodes)有一个定时任务(peersUpdateTask)，会从配置文件拉取availabilityZones以及ServerUrl信息，然后进行更新peerEurekaNodes信息。如果一台Eureka Server挂了，人工介入更改Eureka Server的ServiceUrl信息，可以剔除挂了的peer node。</p>
<h3 id="Client端"><a href="#Client端" class="headerlink" title="Client端"></a>Client端</h3><p>Client端有个定时任务(AsyncResolver.updateTask)去拉取serviceUrl的变更，如果配置文件有变动，运行时可以动态变更。拉去完之后，client端会随机化Server的list。</p>
<p>第一次拉取的时候是按照配置的顺序，之后的定时更新会随机化一次。</p>
<p>Client端在请求Server的时候，维护了一个不可用的Eureka Server列表（quarantineSet,在Connction error或者5xx的情况下会被列入该列表，当该列表的大小超过指定阔值则会重新空）；对可用的Server列表（一般为拉取回来的Server列表剔除不可用的列表，如果剔除后为空，则不会做剔除处理），采用RetryableEurekaHttpClient进行请求，numberOfRetries。也就是说，如果Eureka Server有一台挂掉，则会被纳入不可用列表。那么这个时候获取的服务注册信息是来自健康的Eureka Server。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>现在更多的人选择去使用Nacos了，可以说Eureka作为第一代Spring Cloud最广泛使用的注册中心，还是很有必要了解一下Eureka的。</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">maishuren</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.maishuren.top/posts/springcloud/2020/07/202007010910.html">https://www.maishuren.top/posts/springcloud/2020/07/202007010910.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.maishuren.top" target="_blank">maiBlog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/springcloud/">springcloud</a><a class="post-meta__tags" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/MaiSR9527/blog-pic/banner/blogbanner17.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/pay-for-weichat.png" alt="微信"/><div class="post-qr-code__desc">微信</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/posts/springcloud/2020/07/202007030910.html"><img class="prev_cover" src="https://cdn.jsdelivr.net/gh/MaiSR9527/blog-pic/banner/blogbanner12.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Spring Cloud OpenFeign入门和实战</div></div></a></div><div class="next-post pull_right"><a href="/posts/mysql/2020/06/202006281626.html"><img class="next_cover" src="https://cdn.jsdelivr.net/gh/MaiSR9527/blog-pic/banner/blogbanner7.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Docker容器下配置MySQL主从配置</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/posts/springcloud/2020/07/202007211810.html" title="Spring Cloud Alibaba微服务学习一：服务发现Nacos"><img class="relatedPosts_cover" src="https://cdn.jsdelivr.net/gh/MaiSR9527/blog-pic/banner/blogbanner21.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-07-21</div><div class="relatedPosts_title">Spring Cloud Alibaba微服务学习一：服务发现Nacos</div></div></a></div><div class="relatedPosts_item"><a href="/posts/springcloud/2020/07/202007050910.html" title="Spring Cloud Ribbon入门和实战"><img class="relatedPosts_cover" src="https://cdn.jsdelivr.net/gh/MaiSR9527/blog-pic/banner/blogbanner12.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-07-05</div><div class="relatedPosts_title">Spring Cloud Ribbon入门和实战</div></div></a></div><div class="relatedPosts_item"><a href="/posts/springcloud/2020/07/202007030910.html" title="Spring Cloud OpenFeign入门和实战"><img class="relatedPosts_cover" src="https://cdn.jsdelivr.net/gh/MaiSR9527/blog-pic/banner/blogbanner12.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-07-03</div><div class="relatedPosts_title">Spring Cloud OpenFeign入门和实战</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var requestSetting = function (from,set) {
  var from = from
  var setting = set.split(',').filter(function(item){
  return from.indexOf(item) > -1
  });
  setting = setting.length == 0 ? from :setting;
  return setting
}

var guestInfo = requestSetting(['nick','mail','link'],'nick,mail,link')
var requiredFields = requestSetting(['nick','mail','link'],'nick,mail')

window.valine = new Valine({
  el:'#vcomment',
  appId: '2i3wIjlONBKaR3lajGvjzAFG-gzGzoHsz',
  appKey: 'TeeAbRVflEynyYLIloSk30Xe',
  notify: false,
  verify: false,
  placeholder: 'Please leave your footprints',
  avatar: 'monsterid',
  meta: guestInfo,
  pageSize: '10',
  lang: 'zh-CN',
  recordIP: false,
  serverURLs: '',
  emojiCDN: '',
  emojiMaps: "",
  enableQQ: true,
  requiredFields: requiredFields
});</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By maishuren</div><div class="icp"><a href="http://www.beian.miit.gov.cn/" target="_blank" rel="noopener"><img class="icp-icon" src="/img/icp.png"/><span>粤ICP备20006741号</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
document.body.addEventListener('input', POWERMODE);
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="/js/search/algolia.js"></script><script>var endLoading = function () {
  document.body.style.overflow = 'auto';
  document.getElementById('loading-box').classList.add("loaded")
}
window.addEventListener('load',endLoading)</script></body></html>